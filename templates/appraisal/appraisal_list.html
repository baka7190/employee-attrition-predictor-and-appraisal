{# templates/appraisal/appraisal_list.html #}
{% extends "base.html" %}

{% block title %}My Appraisals{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">My Appraisals</h2>
    <a class="btn btn-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}">
      + New Appraisal
    </a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'info' if category == 'message' else category }} mb-2" role="alert">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if appraisals and appraisals|length %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Period</th>
            <th scope="col">Total</th>
            <th scope="col">Status</th>
            <th scope="col">Created</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in appraisals %}
            {% set sname = a.status.name if a.status else 'DRAFT' %}
            <tr>
              <td>{{ a.id }}</td>
              <td>{{ a.period_start or '—' }} → {{ a.period_end or '—' }}</td>
              <td>{{ a.total_score if a.total_score is not none else '—' }}</td>
              <td>
                {% set st = a.status.value if a.status is not string and a.status is not none else (a.status or '—') %}
                {% set badge = 'secondary' %}
                {% if 'SUBMITTED_TO_MANAGER' in st %}{% set badge = 'info' %}{% endif %}
                {% if 'MANAGER_SUBMITTED' in st %}{% set badge = 'primary' %}{% endif %}
                {% if 'HR_REVIEWED' in st %}{% set badge = 'warning' %}{% endif %}
                {% if 'APPROVED' in st %}{% set badge = 'success' %}{% endif %}
                {% if 'REJECTED' in st %}{% set badge = 'danger' %}{% endif %}
                <span class="badge bg-{{ badge }}">{{ st }}</span>
              </td>
              <td>{{ a.created_at or '—' }}</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('appraisal.appraisal_detail', appraisal_id=a.id) }}">
                  View
                </a>

                {# Allow delete for employee only while not finalized #}
                {% if sname in ['DRAFT', 'SUBMITTED_TO_MANAGER'] %}
                <form method="POST"
                      action="{{ url_for('appraisal.delete_appraisal', appraisal_id=a.id) }}"
                      class="d-inline ms-1"
                      onsubmit="return confirm('Delete appraisal #{{ a.id }}? This cannot be undone.');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">


                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center py-5">
      <p class="mb-3">You don’t have any appraisals yet.</p>
      <a class="btn btn-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}">
        Create your first appraisal
      </a>
    </div>
  {% endif %}
</div>
{% endblock %}
