<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Employee Attrition & Appraisal System{% endblock %}</title>

  <!-- Force theme before CSS loads (prevents FOUC) -->
  <script>
    (function () {
      var key = 'eap-theme';
      var saved = localStorage.getItem(key);
      document.documentElement.setAttribute(
        'data-bs-theme',
        (saved === 'light' || saved === 'dark') ? saved : 'dark'
      );
    })();
  </script>

  {% block head_extra %}{% endblock %}
  {% block head %}{% endblock %}

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      /* Brand */
      --brand:#3b82f6; --brand-2:#22d3ee;

      /* Base (dark) */
      --bg:#0b1220;
      --surface:#111827;
      --ink:#e5e7eb;
      --muted:#9aa4b2;
      --line:rgba(148,163,184,.18);

      --glass:rgba(17,24,39,.65);
      --glass-2:rgba(17,24,39,.45);

      --radius:16px;
      --shadow-md:0 10px 24px rgba(2,6,23,.25);
      --shadow-sm:0 6px 18px rgba(2,6,23,.2);

      /* Colored header + stronger sidebar (dark) */
      --header-bg: linear-gradient(90deg, #1d4ed8 0%, #06b6d4 100%);
      --header-ink: #ffffff;

      /* Final sidebar look (dark) */
      --nav-bg: linear-gradient(180deg, rgba(10,23,55,.96) 0%, rgba(5,14,36,.96) 100%);
      --nav-border: rgba(255,255,255,.08);
      --nav-ink: rgba(255,255,255,.92);
      --nav-ink-muted: rgba(255,255,255,.72);
      --nav-hover: rgba(255,255,255,.12);
      --nav-active: rgba(59,130,246,.22);
    }

    [data-bs-theme="light"]{
      --bg:#f3f6fb;
      --surface:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e6eaf2;
      --glass:rgba(255,255,255,.85);
      --glass-2:rgba(255,255,255,.65);

      /* Colored header + sidebar (light) */
      --header-bg: linear-gradient(90deg, #1d4ed8 0%, #06b6d4 100%);
      --header-ink: #ffffff;

      /* Sidebar look (light) */
      --nav-bg: linear-gradient(180deg, #e9f0ff 0%, #eef7ff 100%);
      --nav-border: rgba(29,78,216,.25);
      --nav-ink: #0b1324;
      --nav-ink-muted: rgba(11,19,36,.72);
      --nav-hover: rgba(29,78,216,.10);
      --nav-active: rgba(29,78,216,.16);
    }

    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1400px 800px at -200px -200px, rgba(34,211,238,.25) 0%, transparent 40%),
        radial-gradient(1200px 700px at 100% 0, rgba(59,130,246,.18) 0%, transparent 35%),
        var(--bg);
      background-attachment: fixed;
      color:var(--ink);
    }

    /* === Layout: Header + Sidebar + Content === */
    .app-header{
      position:sticky; top:0; z-index:1040;
      background: var(--header-bg) !important;
      border-bottom: 0;
      color: var(--header-ink);
      box-shadow: 0 8px 24px rgba(2,6,23,.25);
      backdrop-filter: none; -webkit-backdrop-filter: none;
    }
    .app-header .brand{ display:flex; align-items:center; gap:.65rem; }
    .brand-logo{height:28px}
    .brand-text{font-weight:800; letter-spacing:.3px}
    /* AFTER */
.app-header .nav-link,
.app-header .btn,
.app-header .dropdown-toggle{ color: var(--header-ink) !important; }

/* Restore normal colors inside the dropdown menu */
.app-header .dropdown-menu{
  background: var(--surface);
  border: 1px solid var(--line);
}
.app-header .dropdown-menu .dropdown-item{
  color: var(--ink) !important;
}
.app-header .dropdown-menu .dropdown-item .bi{
  color: inherit !important;
}
.app-header .dropdown-menu .dropdown-item:hover{
  background: var(--nav-hover);
}

    .app-header .nav-link .bi,
    .app-header .btn .bi{ color: var(--header-ink) !important; }
    .app-header .nav-link:hover,
    .app-header .btn:hover{ opacity:.9; }

    .sidebar{
      position:sticky; top:64px;
      height:calc(100dvh - 64px);
      background: var(--nav-bg) !important;
      border-right: 1px solid var(--nav-border) !important;
      box-shadow: inset -1px 0 0 rgba(0,0,0,.08);
      backdrop-filter: none; -webkit-backdrop-filter: none;
    }
    .sidebar .section-title{
      color: var(--nav-ink-muted);
      font-size:.75rem; text-transform:uppercase; letter-spacing:.09em;
      font-weight:600; padding:.75rem .35rem .35rem;
    }
    .sidebar .nav-link{
      color: var(--nav-ink-muted);
      border-radius:12px;
      display:flex; align-items:center; gap:.6rem;
      padding:.6rem .75rem;
      font-weight:500;
      transition: background-color .18s ease, color .18s ease, transform .06s ease;
    }
    .sidebar .nav-link .bi{ color: currentColor; opacity:.95; font-size:1.05rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link:focus{
      color: var(--nav-ink);
      background: var(--nav-hover);
      outline:0;
    }
    .sidebar .nav-link.active{
      color: var(--nav-ink);
      background: var(--nav-active);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
      transform: translateY(-1px);
    }
    .sidebar hr{ border-color: var(--nav-border) !important; }

    .content-wrap{ padding:1.25rem; }
    @media (min-width: 1200px){ .content-wrap{ padding:2rem 2.25rem; } }
    .page-card{
      background:var(--surface); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow-sm);
    }

    /* Utility bar (thin) */
    .utilbar{ background:transparent; color:var(--muted); font-size:.85rem; border-bottom:1px dashed var(--line); }
    .status-dot{width:.52rem;height:.52rem;border-radius:50%;background:#22c55e;display:inline-block;margin-right:.35rem}

    /* Search in header (works on colored header) */
    .header-search .input-group-text{
      background: transparent; color: var(--header-ink); border-color: rgba(255,255,255,.35);
    }
    .header-search .form-control{
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.35);
      color: #fff;
    }
    .header-search .form-control::placeholder{ color: rgba(255,255,255,.85); }

    /* Footer */
    .site-footer{ border-top:1px solid var(--line); background:linear-gradient(180deg, transparent, var(--glass-2)); }
    .footer-main{ padding:24px 0 }

    /* Floating actions */
    .back-to-top{ position:fixed; right:18px; bottom:18px; display:none; z-index:1050; border-radius:50%; box-shadow:var(--shadow-md) }

    /* Dropdown polish & modal */
    .dropdown-menu{ border-radius:12px; box-shadow:var(--shadow-sm) }
    .modal-content{ border-radius:18px } /* overridden by pretty modal below */

    /* Badges / buttons */
    .badge-dot{width:.5rem;height:.5rem;border-radius:50%;display:inline-block}
    .btn-ghost{ border:1px solid var(--line); background:transparent }

    /* Dark-friendly form controls */
    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .input-group-text,
    [data-bs-theme="dark"] .form-select{
      background: rgba(255,255,255,.06);
      border-color: rgba(148,163,184,.25);
      color: var(--ink);
    }
    [data-bs-theme="dark"] .form-control::placeholder{ color: rgba(229,231,235,.55); }

    /* Offcanvas header to match brand (mobile) */
    .offcanvas.text-bg-dark .offcanvas-header{ background: var(--header-bg); }

    /* ===== Pretty modals ===== */
    .modal.fade .modal-dialog { transform: translateY(12px); transition: transform .18s ease, opacity .18s ease; }
    .modal.show .modal-dialog { transform: translateY(0); }

    .modal-content{
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(2,6,23,.35);
      overflow: hidden;
    }
    .modal-header{
      align-items: center; gap:.5rem;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #fff;
    }
    .modal-header .btn-close { filter: invert(1) grayscale(1); opacity:.9; }
    .modal-title{ display:flex; align-items:center; gap:.5rem; font-weight:800; letter-spacing:.2px; }
    .modal-body{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%), transparent;
    }
    .modal-backdrop.show{ backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
    .modal-body h6 { font-weight: 800; }
    .list-group-item.bg-transparent { background: transparent; border-color: var(--line); }
    .accordion-button { border-radius: 12px !important; }
    .accordion-item { background: transparent; border: 1px solid var(--line); border-radius: 12px; overflow: hidden; }
  </style>
</head>

<body class="d-flex flex-column">
{% set USER_ROLE = (session.get('role') or 'EMPLOYEE')|upper %}
{% set logo_url = url_for('static', filename='images/epas-logo.png') %}

  <!-- === Super-thin utility strip === -->
  <div class="utilbar">
    <div class="container-fluid px-3 py-1 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <span class="status-dot"></span><span>System: <strong>Online</strong></span>
        <span class="vr d-none d-md-inline mx-2"></span><span class="d-none d-md-inline">v1.0</span>
      </div>
      <div class="d-none d-sm-flex gap-3 small">
        <a href="#" class="link-secondary text-decoration-none" data-bs-toggle="modal" data-bs-target="#guideModal">Guide</a>
        <a href="#" class="link-secondary text-decoration-none" data-bs-toggle="modal" data-bs-target="#workflowModal">Workflow</a>
        <a href="#" class="link-secondary text-decoration-none" data-bs-toggle="modal" data-bs-target="#modelModal">Model</a>
        <a href="#" class="link-secondary text-decoration-none" data-bs-toggle="modal" data-bs-target="#faqModal">FAQ</a>
        <a href="#" class="link-secondary text-decoration-none" data-bs-toggle="modal" data-bs-target="#reportModal">Report</a>
      </div>
    </div>
  </div>

  <!-- === Header === -->
  <header class="app-header">
    <div class="container-fluid px-3" style="height:64px;">
      <div class="h-100 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-ghost btn-sm d-inline-flex d-xl-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileNav" aria-controls="mobileNav" aria-label="Open menu">
            <i class="bi bi-list"></i>
          </button>
          <a class="brand text-decoration-none text-reset" href="{{ url_for('dashboard') }}">
            <img src="{{ logo_url }}" class="brand-logo" alt="EPAS logo">
            <span class="brand-text">EPAS</span>
          </a>
        </div>

        <form class="header-search d-none d-md-flex" onsubmit="return false;" style="min-width:360px;">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
            <input class="form-control" placeholder="Search (⌘/Ctrl + K)" readonly>
          </div>
        </form>

        <ul class="nav align-items-center gap-1">
          <!-- Notifications -->
<li class="nav-item dropdown">
  <a class="nav-link position-relative px-2" href="#" data-bs-toggle="dropdown" aria-label="Notifications">
    <i class="bi bi-bell"></i>
    {% if notif_count and notif_count > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ notif_count }}</span>
    {% endif %}
  </a>

  {# ========= Helpers ========= #}
  {% set ROLE = USER_ROLE %}
  {% macro label_for(n) -%}
    {# Prediction (Mgr/HR only) #}
    {% if n.type == 'prediction' %}
      {% if n.result in ['Yes','YES','yes', true] %}Prediction · High Attrition Risk
      {% elif n.result in ['No','NO','no', false] %}Prediction · Low Attrition Risk
      {% else %}Prediction · Ready{% endif %}
    {% elif n.type == 'appraisal' %}
      {% if n.action in ['submitted','SUBMITTED'] %}Appraisal Submitted
      {% elif n.action in ['approved','APPROVED'] %}Appraisal Approved
      {% elif n.action in ['not_approved','NOT_APPROVED','rejected','REJECTED'] %}Appraisal Not Approved
      {% elif n.action in ['returned','RETURNED'] %}Appraisal Returned
      {% else %}Appraisal Update{% endif %}
    {% else %}
      {{ n.title or "Activity" }}
    {% endif %}
  {%- endmacro %}

  {% macro dot_for(n) -%}
    {% if n.type == 'prediction' %}
      {% if n.result in ['Yes','YES','yes', true] %}bg-danger{% elif n.result in ['No','NO','no', false] %}bg-success{% else %}bg-primary{% endif %}
    {% elif n.type == 'appraisal' %}
      {% if n.action in ['approved','APPROVED'] %}bg-success
      {% elif n.action in ['not_approved','NOT_APPROVED','rejected','REJECTED'] %}bg-danger
      {% elif n.action in ['returned','RETURNED'] %}bg-warning
      {% elif n.action in ['submitted','SUBMITTED'] %}bg-info
      {% else %}bg-primary{% endif %}
    {% else %}bg-primary{% endif %}
  {%- endmacro %}

  {# Deep links by role so clicking goes to the exact place #}
  {% macro href_for(n) -%}
    {% if n.url %}{{ n.url }}
    {% elif n.type == 'prediction' %}
      {# Managers/HR see history; include anchor when run_id available #}
      {{ url_for('prediction_history') }}{% if n.run_id %}#run-{{ n.run_id }}{% endif %}
    {% elif n.type == 'appraisal' %}
      {# Route based on viewer's role #}
      {% if ROLE == 'MANAGER' %}
        {{ url_for('appraisals_workspace') }}{% if n.appraisal_id %}#appraisal-{{ n.appraisal_id }}{% endif %}
      {% elif ROLE == 'HR' %}
        {{ url_for('hr_review_queue') }}{% if n.appraisal_id %}#appraisal-{{ n.appraisal_id }}{% endif %}
      {% else %}
        {# Employee: go to their dashboard or self-appraisal status #}
        {{ url_for('dashboard') }}{% if n.appraisal_id %}#appraisal-{{ n.appraisal_id }}{% endif %}
      {% endif %}
    {% else %}
      {{ url_for('dashboard') }}
    {% endif %}
  {%- endmacro %}

  {# Visibility: Employees see only appraisal; Managers/HR see appraisal + prediction #}
  {% macro is_visible(n) -%}
    {% if ROLE in ['MANAGER','HR'] %}
      {{ n.type in ['appraisal','prediction'] }}
    {% else %}
      {{ n.type == 'appraisal' }}
    {% endif %}
  {%- endmacro %}

  <div class="dropdown-menu dropdown-menu-end p-0" style="width:340px;max-height:420px;overflow:auto;">
    <div class="list-group list-group-flush small">
      {% set any_rendered = false %}
      {% if notif_items and notif_items|length %}
        {% for n in notif_items %}
          {% if is_visible(n) %}
            {% set any_rendered = true %}
            <a class="list-group-item d-flex align-items-start gap-2 text-decoration-none position-relative"
               href="{{ href_for(n) }}">
              <span class="badge-dot {{ dot_for(n) }} mt-2"></span>
              <div>
                <div class="fw-medium">
                  {{ label_for(n) }}
                  {% if n.employee_name %}<span class="text-muted"> · {{ n.employee_name }}</span>{% endif %}
                </div>
                <div class="text-muted">{{ (n.timestamp or n.created_at).strftime("%Y-%m-%d %H:%M") }}</div>
              </div>
              <span class="stretched-link" aria-hidden="true"></span>
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}
      {% if not any_rendered %}
        <div class="list-group-item text-center text-muted">No new notifications</div>
      {% endif %}
    </div>
  </div>
</li>


          <!-- Theme toggle -->
          <li class="nav-item">
            <button id="themeToggle" class="btn btn-ghost btn-sm" type="button" aria-label="Toggle theme">
              <i class="bi bi-moon-stars" id="themeIcon"></i>
            </button>
          </li>

          <!-- User -->
          {% if current_user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 px-2" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:32px;height:32px;background:rgba(59,130,246,.2);color:#1e3a8a;font-weight:700;">
                {{ current_user.username[:2]|upper }}
              </span>
              <span class="d-none d-lg-inline text-truncate" style="max-width:160px;">{{ current_user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-person me-2"></i> Profile</a></li>
              <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item d-none d-sm-block">
            <a href="{{ url_for('recover') }}" class="btn btn-link btn-sm text-decoration-none">Forgot Password</a>
          </li>
          <li class="nav-item">
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#signupModal"><i class="bi bi-person-plus"></i> Create</button>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </header>

  <!-- === Body: Sidebar + Content === -->
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar (static on xl+, collapsible on smaller) -->
      <aside class="sidebar col-xl-2 d-none d-xl-flex flex-column px-3 py-3">
        <div class="section-title">Navigation</div>
        <nav class="nav flex-column gap-1">
          {% block nav_items %}{% endblock %}
          <div class="dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-grid-1x2"></i> Dashboards
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('dashboard') }}">My Dashboard</a></li>
              {% if session.get('role')|lower in ['manager','hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_manager') }}">Manager</a></li>{% endif %}
              {% if session.get('role')|lower in ['hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_hr') }}">HR</a></li>{% endif %}
              {% if session.get('role')|lower == 'admin' %}<li><a class="dropdown-item" href="{{ url_for('dashboard_admin') }}">Admin</a></li>{% endif %}
            </ul>
          </div>
          {% if session.get('role')|lower in ['manager','hr'] %}
            <a class="nav-link" href="{{ url_for('predict') }}"><i class="bi bi-magic"></i> Predict</a>
            <a class="nav-link" href="{{ url_for('prediction_history') }}"><i class="bi bi-clock-history"></i> History</a>
          {% endif %}
        </nav>

        <hr class="my-3 text-secondary">

        <div class="section-title">Resources</div>
        <nav class="nav flex-column gap-1">
          <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#guideModal"><i class="bi bi-journal-text"></i> User Guide</a>
          <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#workflowModal"><i class="bi bi-diagram-3"></i> Workflow</a>
          <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#modelModal"><i class="bi bi-cpu"></i> Model</a>
          <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#faqModal"><i class="bi bi-question-circle"></i> FAQ</a>
          <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#reportModal"><i class="bi bi-flag"></i> Report</a>
        </nav>
      </aside>

      <!-- Content -->
      <main id="main-content" class="col-xl-10 content-wrap">
        <div class="page-card p-3 p-md-4 p-lg-5">
          {% block content %}{% endblock %}
        </div>

        <!-- Footer inside content flow -->
        <footer class="site-footer mt-4">
          <div class="footer-main">
            <div class="row g-4 align-items-start">
              <div class="col-lg-4">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <img src="{{ logo_url }}" alt="EPAS logo" style="height:30px;">
                  <strong>EPAS</strong>
                </div>
                <p class="small text-muted mb-2">Employee Attrition & Appraisal System helps forecast attrition and manage structured appraisals.</p>
                <p class="small text-muted mb-0">&copy; {{ current_year }} EAAS · All rights reserved.</p>
              </div>
              <div class="col-lg-4">
                <div class="fw-bold mb-1">Contact</div>
                <p class="small text-muted mb-1">Support: support@eapas.com</p>
                <p class="small text-muted">Hours: Mon–Fri, 08:00–17:00</p>
                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-secondary" href="#"><i class="bi bi-linkedin"></i></a>
                  <a class="btn btn-sm btn-outline-secondary" href="#"><i class="bi bi-github"></i></a>
                </div>
              </div>
            </div>
          </div>
        </footer>
      </main>
    </div>
  </div>

  <!-- Mobile Offcanvas -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mobileNav" aria-labelledby="mobileNavLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title d-flex align-items-center gap-2" id="mobileNavLabel">
        <img src="{{ logo_url }}" class="brand-logo" alt> <span class="fw-bold">EPAS</span>
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column gap-3">
      <form class="d-flex" onsubmit="return false;">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control" placeholder="Search…" readonly>
        </div>
      </form>
      <div class="section-title text-uppercase small">Navigation</div>
      <ul class="navbar-nav">
        {{ self.nav_items() }}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-grid-1x2"></i> Dashboards
          </a>
          <ul class="dropdown-menu dropdown-menu-dark">
            <li><a class="dropdown-item" href="{{ url_for('dashboard') }}">My Dashboard</a></li>
            {% if session.get('role')|lower in ['manager','hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_manager') }}">Manager</a></li>{% endif %}
            {% if session.get('role')|lower in ['hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_hr') }}">HR</a></li>{% endif %}
            {% if session.get('role')|lower == 'admin' %}<li><a class="dropdown-item" href="{{ url_for('dashboard_admin') }}">Admin</a></li>{% endif %}
          </ul>
        </li>
        {% if session.get('role')|lower in ['manager','hr'] %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('predict') }}"><i class="bi bi-magic"></i> Predict</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('prediction_history') }}"><i class="bi bi-clock-history"></i> History</a></li>
        {% endif %}
      </ul>
      <div class="mt-auto">
        {% if not current_user.is_authenticated %}
          <a href="{{ url_for('recover') }}" class="btn btn-link text-decoration-none text-white-50 w-100">Forgot Password</a>
          <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#signupModal"><i class="bi bi-person-plus"></i> Create Account</button>
        {% else %}
          <a class="btn btn-outline-light w-100 mb-2" href="#" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-person"></i> Profile</a>
          <a class="btn btn-light w-100" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Logout</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Global Register Modal -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header text-white" style="background:linear-gradient(90deg,var(--brand),var(--brand-2))">
          <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i> Create your account</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form class="needs-validation" method="POST" action="{{ url_for('register') }}" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

          <div class="modal-body p-4">
            <div class="d-flex justify-content-end gap-2 mb-3" id="demoFillers">
              <button type="button" class="btn btn-outline-primary btn-sm" data-fill="employee">Sample: Employee</button>
              <button type="button" class="btn btn-outline-success btn-sm" data-fill="manager">Sample: Manager</button>
              <button type="button" class="btn btn-outline-info btn-sm" data-fill="hr">Sample: HR</button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Username <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input name="username" type="text" class="form-control" placeholder="e.g. jdoe" required minlength="3" maxlength="32">
                  <div class="invalid-feedback">Please enter a username (3–32 chars).</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                  <input name="email" type="email" class="form-control" placeholder="you@company.com" required>
                  <div class="invalid-feedback">Enter a valid email.</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lock"></i></span>
                  <input id="pw1" name="password" type="password" class="form-control" placeholder="At least 8 characters" required minlength="8">
                  <button class="btn btn-outline-secondary" type="button" id="togglePw1" aria-label="Show/Hide"><i class="bi bi-eye"></i></button>
                  <div class="invalid-feedback">Minimum 8 characters.</div>
                </div>
                <div class="progress mt-2" style="height:6px"><div id="pwStrength" class="progress-bar" role="progressbar" style="width:0%"></div></div>
                <div id="pwHint" class="form-text">Use upper/lowercase, a number, and a symbol.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                  <input id="pw2" name="confirm_password" type="password" class="form-control" placeholder="Re-type password" required minlength="8">
                  <button class="btn btn-outline-secondary" type="button" id="togglePw2" aria-label="Show/Hide"><i class="bi bi-eye"></i></button>
                  <div class="invalid-feedback">Passwords must match.</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Role <span class="text-danger">*</span></label>
                <select id="signupRoleSelect" name="role" class="form-select" required>
                  <option value="" selected disabled>Choose a role…</option>
                  <option value="EMPLOYEE">Employee</option>
                  <option value="MANAGER">Manager</option>
                  <option value="HR">HR</option>
                </select>
                <div class="invalid-feedback">Please select a role.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Agreement</label>
                <div class="form-check">
                  <input id="agree" class="form-check-input" type="checkbox" required>
                  <label class="form-check-label" for="agree">
                    I agree to the <a href="#" class="link-secondary">Terms</a> and <a href="#" class="link-secondary">Privacy Policy</a>.
                  </label>
                  <div class="invalid-feedback">You must accept the terms to continue.</div>
                </div>
              </div>
            </div>

            <hr class="my-4">
            <h6 class="mb-3 d-flex align-items-center gap-2"><i class="bi bi-card-checklist"></i> Employee Details</h6>
            <div id="employeeFields" class="row g-3 d-none">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-person-vcard"></i></span><input name="name" type="text" class="form-control" placeholder="e.g. Jane Doe"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Employee ID</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-hash"></i></span><input name="employee_id" type="text" class="form-control" placeholder="e.g. EMP-00123"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Department</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-building"></i></span><input name="department" type="text" class="form-control" placeholder="e.g. Engineering"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Job Title</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-briefcase"></i></span><input name="title" type="text" class="form-control" placeholder="e.g. Software Engineer"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Manager</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-person-gear"></i></span><input name="manager_name" type="text" class="form-control" placeholder="e.g. Alex Smith"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-telephone"></i></span><input name="phone" type="text" class="form-control" placeholder="e.g. +1 555 555 5555"></div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Location</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-geo-alt"></i></span><input name="location" type="text" class="form-control" placeholder="e.g. New York, NY"></div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between">
            <div class="text-muted small d-flex align-items-center gap-2">
              <i class="bi bi-shield-check"></i>
              <span>New accounts are created as <strong>Pending</strong> until approved by an Admin.</span>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="signupSubmit" type="submit" class="btn btn-primary"><i class="bi bi-person-check"></i> Create Account</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Floating back-to-top -->
  <a href="#" class="back-to-top btn btn-light" aria-label="Back to top"><i class="bi bi-arrow-up-short fs-3"></i></a>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ===== Modal niceties (after Bootstrap is loaded) ===== -->
  <script>
    (function(){
      // Focus the first focusable control when a modal opens
      document.addEventListener('shown.bs.modal', (ev) => {
        const dlg = ev.target;
        const first = dlg.querySelector('input, select, textarea, button, a[href]');
        first && first.focus();
      });

      // Keep ESC from closing while user is typing in a field
      document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const typing = m.querySelector('input:focus, textarea:focus');
            if (typing) e.stopPropagation();
          }
        });
      });

      // Remember last-opened resource modal and reopen with Ctrl/Cmd + /
      const RES_KEY='epas:lastModal';
      document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target]').forEach(a=>{
        a.addEventListener('click', ()=>localStorage.setItem(RES_KEY, a.getAttribute('data-bs-target')));
      });
      window.addEventListener('keydown',(e)=>{
        const isMac=/Mac|iPod|iPhone|iPad/.test(navigator.platform);
        if ((isMac?e.metaKey:e.ctrlKey) && e.key === '/') {
          e.preventDefault();
          const id = localStorage.getItem(RES_KEY) || '#guideModal';
          const el = document.querySelector(id);
          if (el) new bootstrap.Modal(el).show();
        }
      });
    })();
  </script>

  <!-- App Scripts -->
  <script>
    // Elevation/back-to-top
    const backTop=document.querySelector('.back-to-top');
    window.addEventListener('scroll',()=>{const s=window.scrollY; backTop.style.display=s>240?'inline-flex':'none';});
    backTop?.addEventListener('click',e=>{e.preventDefault();window.scrollTo({top:0,behavior:'smooth'})});

    // Theme toggle (persist; default dark unless explicitly saved light)
    (function(){
      const root = document.documentElement;
      const key  = 'eap-theme';
      const btn  = document.getElementById('themeToggle');
      const icon = document.getElementById('themeIcon');

      function setTheme(t){
        root.setAttribute('data-bs-theme', t);
        localStorage.setItem(key, t);
        if (icon) icon.className = (t === 'dark') ? 'bi bi-sun' : 'bi bi-moon-stars';
      }

      const saved = localStorage.getItem(key);
      setTheme((saved === 'light' || saved === 'dark') ? saved : 'dark');

      btn && btn.addEventListener('click', () => {
        setTheme(root.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark');
      });
    })();

    // Modal helpers: strength + show/hide + conditional fields
    (function(){
      const form = document.querySelector('#signupModal form.needs-validation');
      const pw1 = document.getElementById('pw1');
      const pw2 = document.getElementById('pw2');
      const bar = document.getElementById('pwStrength');
      const hint = document.getElementById('pwHint');

      function togglePw(input, btnId){
        const btn = document.getElementById(btnId);
        const eye = btn.querySelector('i');
        input.type = (input.type === 'password') ? 'text' : 'password';
        eye.className = (input.type === 'password') ? 'bi bi-eye' : 'bi bi-eye-slash';
      }
      document.getElementById('togglePw1')?.addEventListener('click', ()=>togglePw(pw1,'togglePw1'));
      document.getElementById('togglePw2')?.addEventListener('click', ()=>togglePw(pw2,'togglePw2'));

      function updateStrength(){
        const v = pw1?.value || '';
        const rules = [/[a-z]/,/[A-Z]/,/\d/,/[^A-Za-z0-9]/,/.{12,}/].map(r=>r.test(v));
        const score = rules.filter(Boolean).length;
        const pct = (score/5)*100;
        bar.style.width = pct + '%';
        bar.className = 'progress-bar';
        if (score <= 2) { bar.classList.add('bg-danger'); hint.textContent='Weak'; }
        else if (score === 3) { bar.classList.add('bg-warning'); hint.textContent='Fair'; }
        else if (score === 4) { bar.classList.add('bg-info'); hint.textContent='Good'; }
        else { bar.classList.add('bg-success'); hint.textContent='Strong'; }
      }
      pw1?.addEventListener('input', updateStrength);

      function pwMatch(){
        const ok = (pw1.value === pw2.value);
        pw2.setCustomValidity(ok ? '' : 'Passwords do not match'); return ok;
      }
      pw2?.addEventListener('input', pwMatch);

      const roleSelect = document.getElementById('signupRoleSelect');
      const empWrap = document.getElementById('employeeFields');
      const empNames = ['name','employee_id','department','title','manager_name','phone','location'];
      function updateEmployeeFields(){
        const isEmp = roleSelect?.value === 'EMPLOYEE';
        empWrap?.classList.toggle('d-none', !isEmp);
        empNames.forEach(n=>{
          const el = document.querySelector(`#signupModal [name="${n}"]`);
          if (!el) return;
          if (isEmp) el.setAttribute('required','');
          else el.removeAttribute('required');
        });
      }
      roleSelect?.addEventListener('change', updateEmployeeFields);

      form?.addEventListener('submit', (ev)=>{
        if (!form.checkValidity() || !pwMatch()) {
          ev.preventDefault(); ev.stopPropagation();
        }
        form.classList.add('was-validated');
      });
    })();

    // Demo autofill buttons
    (function(){
      const samples = {
        employee: { username: "evelyn.park", email: "evelyn.park@acme.com", password: "EPark#2025!", role: "EMPLOYEE", agree: true,
          details: { name: "Evelyn Park", employee_id: "E10234", department: "Sales", title: "Sales Associate", manager_name: "Jordan Reed", phone: "512-555-0163", location: "Austin, TX" } },
        manager:  { username: "marco.lee",  email: "marco.lee@acme.com",  password: "MLee#2025!",  role: "MANAGER", agree: true },
        hr:       { username: "nina.patel", email: "nina.patel@acme.com", password: "NPatel#2025!", role: "HR",      agree: true }
      };

      const $form = document.querySelector('#signupModal form.needs-validation');
      if (!$form) return;

      const $user  = $form.querySelector('[name="username"]');
      const $email = $form.querySelector('[name="email"]');
      const $pw1   = $form.querySelector('#pw1');
      const $pw2   = $form.querySelector('#pw2');
      const $role  = $form.querySelector('#signupRoleSelect');
      const $agree = $form.querySelector('#agree');

      function setVal(el, v){ if(!el) return; el.value = v; el.dispatchEvent(new Event('input', { bubbles:true })); }
      function setChecked(el, v){ if(el) el.checked = !!v; }
      function setChange(el){ if(el) el.dispatchEvent(new Event('change', { bubbles:true })); }

      function fillDetails(d){
        if(!d) return;
        ['name','employee_id','department','title','manager_name','phone','location'].forEach(n=>{
          const el = $form.querySelector(`[name="${n}"]`);
          if (el) setVal(el, d[n] ?? '');
        });
      }

      function fill(sample){
        if(!sample) return;
        setVal($user, sample.username);
        setVal($email, sample.email);
        setVal($pw1, sample.password);
        setVal($pw2, sample.password);
        if ($role) { $role.value = sample.role; setChange($role); }
        setChecked($agree, sample.agree);
        fillDetails(sample.details);
      }

      document.querySelectorAll('#demoFillers [data-fill]').forEach(btn=>{
        btn.addEventListener('click', ()=> fill(samples[btn.dataset.fill]));
      });
    })();

    // CSRF header for fetch
    (function(){
      const CSRF = document.querySelector('meta[name="csrf-token"]')?.content;
      if (!window.fetch || !CSRF) return;
      const origFetch = window.fetch;
      window.fetch = (input, init={})=>{
        const method = (init.method||'GET').toUpperCase();
        if (['POST','PUT','PATCH','DELETE'].includes(method)) {
          init.headers = Object.assign({}, init.headers, {'X-CSRFToken': CSRF});
        }
        return origFetch(input, init);
      };
    })();

    // Command palette hint (Ctrl/Cmd+K could focus header search later)
    (function(){
      const field = document.querySelector('.header-search input');
      window.addEventListener('keydown', (e)=>{
        const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform);
        if ((isMac && e.metaKey && e.key.toLowerCase()==='k') || (!isMac && e.ctrlKey && e.key.toLowerCase()==='k')) {
          e.preventDefault(); field?.focus();
        }
      });
    })();
  </script>

  <!-- Page-specific scripts -->
  {% block scripts_extra %}{% endblock %}

  <!-- User Guide -->
  <div class="modal fade" id="guideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-journal-text me-2"></i>User Guide</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
  {% if USER_ROLE == 'MANAGER' %}
    <div class="row g-3">
      <div class="col-md-7">
        <h6 class="mb-1">Manager Quick Start</h6>
        <ol class="small">
          <li>Go to <strong>Dashboards → Manager</strong> for your overview.</li>
          <li>Use <strong>Appraisals · Workspace</strong> to review, return, or finalize team reviews.</li>
          <li>Run <strong>Predict</strong> to score an employee; check <strong>History</strong> for past runs.</li>
          <li>Watch the <strong>High-Risk Watchlist</strong> and follow up with each employee.</li>
          <li>Export reports (PDF/Excel/CSV) from the Manager dashboard when needed.</li>
        </ol>
        <div class="alert alert-info small mb-0">
          Tip: Filter the <em>Team Predictions</em> table by role or name to focus your follow-ups.
        </div>
      </div>
      <div class="col-md-5">
        <h6 class="mb-1">Where things live</h6>
        <ul class="small mb-0">
          <li><strong>Predict:</strong> score one or many (Batch Upload)</li>
          <li><strong>History:</strong> confidence, inputs, and details</li>
          <li><strong>Appraisals:</strong> Pending / Returned / Finalized lanes</li>
          <li><strong>Exports:</strong> Reports for stakeholders</li>
        </ul>
      </div>
    </div>

  {% elif USER_ROLE == 'HR' %}
    <div class="row g-3">
      <div class="col-md-7">
        <h6 class="mb-1">HR Quick Start</h6>
        <ol class="small">
          <li>Open <strong>Dashboards → HR</strong> to see risk, progress, and queues.</li>
          <li>Use <strong>Operations &amp; Reports</strong> to <em>Define Criteria</em>, <em>Assign Reviewers</em>, and <em>Launch Cycle</em>.</li>
          <li>Monitor <strong>HR Review Queue</strong>; return items with notes or finalize as needed.</li>
          <li>Use <strong>Exports</strong> (PDF/Excel/CSV) for compliance and calibration sessions.</li>
          <li>Correlate <strong>Overtime vs Risk</strong> and <strong>Risk by Tenure/Dept</strong> to plan interventions.</li>
        </ol>
        <div class="alert alert-warning small mb-0">
          Note: Only HR can change appraisal criteria and launch/close cycles.
        </div>
      </div>
      <div class="col-md-5">
        <h6 class="mb-1">Key areas</h6>
        <ul class="small mb-0">
          <li><strong>HR Review:</strong> open / return / finalize</li>
          <li><strong>Cycle Progress:</strong> status by department</li>
          <li><strong>Signals:</strong> risk and throughput indicators</li>
          <li><strong>Predict/History:</strong> bulk or ad-hoc scoring</li>
        </ul>
      </div>
    </div>

  {% else %}
    <!-- Employee default -->
    <object data="{{ url_for('static', filename='docs/user_guide.pdf') }}"
            type="application/pdf" width="100%" style="height:70vh">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Getting Started</h6>
          <ol class="small mb-0">
            <li>Open <strong>Dashboards → My Dashboard</strong>.</li>
            <li>Click <strong>Start / Continue Self-Appraisal</strong>.</li>
            <li>Complete each section and submit to your manager.</li>
          </ol>
        </div>
        <div class="col-md-6">
          <h6>Tips</h6>
          <ul class="small mb-0">
            <li>Use <kbd>Ctrl/Cmd + K</kbd> to jump to search.</li>
            <li>Toggle light/dark in the header.</li>
            <li>Check status of your appraisal any time.</li>
          </ul>
        </div>
      </div>
    </object>
  {% endif %}
        </div>
        <div class="modal-footer">
          <a class="btn btn-outline-secondary" href="{{ url_for('static', filename='docs/user_guide.pdf') }}" download>Download PDF</a>
          <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workflow -->
  <div class="modal fade" id="workflowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-diagram-3 me-2"></i>Workflow</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
  {% if USER_ROLE == 'MANAGER' %}
    <ol class="list-group list-group-numbered">
      <li class="list-group-item bg-transparent">Employees submit self-appraisals to you.</li>
      <li class="list-group-item bg-transparent">You review, add comments, and return if fixes are needed.</li>
      <li class="list-group-item bg-transparent">Approve and forward to HR when ready.</li>
      <li class="list-group-item bg-transparent">Monitor <strong>Returned by HR</strong> to address issues promptly.</li>
      <li class="list-group-item bg-transparent">Use <strong>Predict</strong> + <strong>History</strong> to inform calibration.</li>
    </ol>

  {% elif USER_ROLE == 'HR' %}
    <ol class="list-group list-group-numbered">
      <li class="list-group-item bg-transparent">Define criteria &amp; assign reviewers; launch cycle.</li>
      <li class="list-group-item bg-transparent">Managers review and submit to HR.</li>
      <li class="list-group-item bg-transparent">HR audits: return with notes or finalize.</li>
      <li class="list-group-item bg-transparent">Calibrate ratings across departments.</li>
      <li class="list-group-item bg-transparent">Export results; communicate outcomes.</li>
    </ol>

  {% else %}
    <ol class="list-group list-group-numbered">
      <li class="list-group-item bg-transparent">Complete self-appraisal and submit to your manager.</li>
      <li class="list-group-item bg-transparent">Address any returns and re-submit.</li>
      <li class="list-group-item bg-transparent">Manager approves → HR finalizes.</li>
      <li class="list-group-item bg-transparent">View your final rating when cycle closes.</li>
    </ol>
  {% endif %}
        </div>
        <div class="modal-footer">
          <a href="{{ url_for('dashboard') }}" class="btn btn-primary"><i class="bi bi-rocket-takeoff me-1"></i>Go to Dashboard</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Model -->
  <div class="modal fade" id="modelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cpu me-2"></i>Model Overview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2">This system forecasts attrition risk using factors like tenure, role, performance, satisfaction, and compensation.</p>
          <ul class="list-group">
            <li class="list-group-item bg-transparent d-flex justify-content-between">
              <span>Target</span><span class="fw-semibold">Attrition (Yes/No)</span>
            </li>
            <li class="list-group-item bg-transparent d-flex justify-content-between">
              <span>Outputs</span><span class="fw-semibold">Risk score + key drivers</span>
            </li>
            <li class="list-group-item bg-transparent">
              <div class="fw-semibold mb-1">Role Guidance</div>
              {% if USER_ROLE == 'MANAGER' %}
                <div class="small">Use <strong>Predict</strong> for at-risk individuals and <strong>History</strong> before 1:1s and calibration. Coordinate actions with HR.</div>
              {% elif USER_ROLE == 'HR' %}
                <div class="small">Run <strong>batch predictions</strong>, validate drivers vs. HR data, and incorporate results into <strong>cycle calibration</strong> and policy.</div>
              {% else %}
                <div class="small">Predictions are run by Managers/HR to plan retention and development actions.</div>
              {% endif %}
            </li>
          </ul>
        </div>
        <div class="modal-footer">
          {% if session.get('role')|lower in ['manager','hr'] %}
            <a href="{{ url_for('predict') }}" class="btn btn-primary"><i class="bi bi-magic me-1"></i>Run Prediction</a>
            <a href="{{ url_for('prediction_history') }}" class="btn btn-outline-secondary">View History</a>
          {% else %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ -->
  <div class="modal fade" id="faqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-question-circle me-2"></i>FAQ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
  {% if USER_ROLE == 'MANAGER' %}
    <div class="accordion" id="faqAccMgr">
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#m1">How do I return an appraisal?</button></h2>
        <div id="m1" class="accordion-collapse collapse" data-bs-parent="#faqAccMgr">
          <div class="accordion-body small">Open <em>Appraisals · Workspace</em> → <strong>Returned by HR</strong> or <strong>Awaiting HR</strong>, choose an item, add notes, and click <strong>Return</strong>.</div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#m2">Where do I see prediction details?</button></h2>
        <div id="m2" class="accordion-collapse collapse" data-bs-parent="#faqAccMgr">
          <div class="accordion-body small">Go to <strong>History</strong> and click <strong>Details</strong> to view inputs, confidence, and drivers.</div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#m3">What should I do with high-risk employees?</button></h2>
        <div id="m3" class="accordion-collapse collapse" data-bs-parent="#faqAccMgr">
          <div class="accordion-body small">Use the <strong>Watchlist</strong> on the Manager dashboard, coordinate with HR for retention actions, and document outcomes.</div>
        </div>
      </div>
    </div>

  {% elif USER_ROLE == 'HR' %}
    <div class="accordion" id="faqAccHr">
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#h1">How do I launch a cycle?</button></h2>
        <div id="h1" class="accordion-collapse collapse" data-bs-parent="#faqAccHr">
          <div class="accordion-body small">Open <strong>Ops &amp; Reports</strong> → <strong>Launch Cycle</strong>. Make sure criteria and reviewers are configured first.</div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#h2">How do I finalize or return items?</button></h2>
        <div id="h2" class="accordion-collapse collapse" data-bs-parent="#faqAccHr">
          <div class="accordion-body small">Use the <strong>HR Review Queue</strong>: open an item, add notes if returning, or click <strong>Finalize</strong> to close.</div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#h3">Where are exports?</button></h2>
        <div id="h3" class="accordion-collapse collapse" data-bs-parent="#faqAccHr">
          <div class="accordion-body small">Right rail or <strong>Ops &amp; Reports</strong> header buttons: PDF, Excel, CSV.</div>
        </div>
      </div>
    </div>

  {% else %}
    <div class="accordion" id="faqAccEmp">
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#e1">How do I start my appraisal?</button></h2>
        <div id="e1" class="accordion-collapse collapse" data-bs-parent="#faqAccEmp">
          <div class="accordion-body small">Open <em>My Dashboard</em> and click <strong>Start / Continue Self-Appraisal</strong>.</div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#e2">What if my manager returns it?</button></h2>
        <div id="e2" class="accordion-collapse collapse" data-bs-parent="#faqAccEmp">
          <div class="accordion-body small">You’ll get a note. Update the sections requested and re-submit.</div>
        </div>
      </div>
    </div>
  {% endif %}
        </div>
        <div class="modal-footer">
          <a class="btn btn-outline-secondary" href="{{ url_for('static', filename='docs/faq.pdf') }}" download>Download FAQ</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Report -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form onsubmit="event.preventDefault()">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-flag me-2"></i>Report an Issue / Feedback</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Subject</label>
              <input type="text" class="form-control" id="repSubject" placeholder="Short summary">
            </div>
            <div class="mb-3">
              <label class="form-label">Details</label>
              <textarea class="form-control" id="repDetails" rows="5" placeholder="What happened? Steps to reproduce?"></textarea>
            </div>
            <div class="form-text">Or email us directly: <a href="mailto:support@eapas.com?subject=EPAS%20Feedback">support@eapas.com</a></div>
          </div>
          <div class="modal-footer">
            <a id="repMail" class="btn btn-primary" href="#" target="_blank" rel="noopener"><i class="bi bi-send me-1"></i>Send via Email</a>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Turn the Report form into a mailto on the fly (no backend needed)
    (function(){
      const btn = document.getElementById('repMail');
      if(!btn) return;
      btn.addEventListener('click', function(){
        const s = encodeURIComponent(document.getElementById('repSubject')?.value || 'EPAS Feedback');
        const b = encodeURIComponent(document.getElementById('repDetails')?.value || '');
        this.href = `mailto:support@eapas.com?subject=${s}&body=${b}`;
      });
    })();
  </script>
{% include "partials/confirm_modal.html" %}
</body>
</html>
