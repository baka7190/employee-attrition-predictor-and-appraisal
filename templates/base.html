<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Employee Attrition & Appraisal System{% endblock %}</title>

  <!-- Per-page extra head (styles, meta, etc.) -->
  {% block head_extra %}{% endblock %}

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
  :root{
    --brand:#2563eb; --brand-2:#0ea5e9;
    --navy-900:#0b1220; --navy-800:#101a2e;
    --surface:#ffffff; --page-top:#f7f9fc; --page-bottom:#f3f6fb;
    --ink:#0f172a; --muted:#6b7280; --line:#e6eaf2;
    --shadow-lg:0 14px 38px rgba(2,6,23,.14);
    --shadow-md:0 10px 24px rgba(2,6,23,.10); --radius:14px;
  }
  html,body{height:100%}
  body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
       color:var(--ink); background:linear-gradient(180deg, var(--page-top), var(--page-bottom)); background-attachment: fixed;}

  /* HEADER */
  .utilbar{background:#0e1526;color:rgba(255,255,255,.8);font-size:.85rem;position:sticky;top:0;z-index:1031;border-bottom:1px solid rgba(255,255,255,.06);}
  .utilbar .container-xxl{display:flex;align-items:center;justify-content:space-between;padding:.35rem 0;}
  .status-dot{width:.55rem;height:.55rem;border-radius:50%;background:#22c55e;display:inline-block;margin-right:.35rem;}
  .util-links a{color:rgba(255,255,255,.85);margin-right:14px;text-decoration:none;}
  .util-links a:hover{color:#fff;}

  .appbar{background:linear-gradient(180deg,rgba(11,18,32,.92),rgba(16,26,46,.88));backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
          color:#fff;position:sticky;top:26px;z-index:1030;border-bottom:1px solid rgba(255,255,255,.06);transition:box-shadow .25s ease;}
  .appbar.elevated{box-shadow:0 10px 30px rgba(2,6,23,.35);}
  .navbar-brand{display:flex;align-items:center;gap:.6rem;}
  .brand-logo{height:28px;}
  .brand-text{font-weight:600;letter-spacing:.2px;}
  .nav-search{min-width:260px;}
  @media(max-width:991.98px){.nav-search{min-width:100%;}}
  .nav-search .form-control{background:rgba(255,255,255,.12);color:#fff;border-color:rgba(255,255,255,.18);}
  .nav-search .form-control::placeholder{color:rgba(255,255,255,.65);}
  .avatar{width:34px;height:34px;border-radius:50%;background:#64748b;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:700;}

  /* auth actions on mobile */
  .nav-actions { display:flex; gap:12px; align-items:center; }
  @media (max-width: 992px){
    .nav-actions { flex-direction:column; width:100%; padding-top:10px; }
    .nav-actions a, .nav-actions button { width:100%; text-align:center; }
  }

  /* FOOTER */
  .site-footer{background:#fff;margin-top:auto;border-top:1px solid var(--line);}
  .footer-main{padding:28px 0;}
  .footer-title{font-weight:700;margin-bottom:.6rem;}
  .footer-links a{margin:0 .75rem .4rem 0;color:#475569;text-decoration:none;}
  .footer-links a:hover{color:var(--brand);}
  .footer-meta{border-top:1px solid var(--line);background:#f8fafc;color:#64748b;}
  .footer-meta .container-xxl{display:flex;align-items:center;justify-content:space-between;padding:.65rem 0;}
  .footer-logo{height:34px;filter:drop-shadow(0 2px 6px rgba(2,6,23,.12));}
  .back-to-top{position:fixed;right:20px;bottom:20px;display:none;z-index:1050;border-radius:50%;box-shadow:var(--shadow-md);}
  </style>
</head>

<body class="d-flex flex-column">
  {% set logo_url = url_for('static', filename='images/epas-logo.png') %}
  <!--<a class="skip-link" href="#main-content">Skip to content</a>-->

  <!-- Utility strip -->
  <div class="utilbar">
    <div class="container-xxl">
      <div class="d-flex align-items-center gap-3">
        <span class="status-dot"></span><span>System: <strong>Online</strong></span>
        <span class="vr d-none d-md-inline mx-2"></span><span class="d-none d-md-inline">v1.0</span>
      </div>
      <div class="util-links small">
        <a href="#">User Guide</a><a href="#">Workflow</a><a href="#">Model</a><a href="#">FAQ</a><a href="#">Report</a>
      </div>
    </div>
  </div>

  <!-- App bar -->
  <nav class="navbar navbar-expand-lg navbar-dark appbar">
    <div class="container-xxl">
      <a class="navbar-brand" href="{{ url_for('dashboard') }}">
        <img src="{{ logo_url }}" alt="EPAS logo" class="brand-logo"><span class="brand-text">EPAS</span>
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#topNav"><span class="navbar-toggler-icon"></span></button>

      <div id="topNav" class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">{% block nav_items %}{% endblock %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"><i class="bi bi-speedometer2 me-1"></i> Dashboards</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="{{ url_for('dashboard') }}">My Dashboard</a></li>
              {% if session.get('role')|lower in ['manager','hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_manager') }}">Manager</a></li>{% endif %}
              {% if session.get('role')|lower in ['hr','admin'] %}<li><a class="dropdown-item" href="{{ url_for('dashboard_hr') }}">HR</a></li>{% endif %}
              {% if session.get('role')|lower == 'admin' %}<li><a class="dropdown-item" href="{{ url_for('dashboard_admin') }}">Admin</a></li>{% endif %}
            </ul>
          </li>
          {% if session.get('role')|lower in ['manager','hr'] %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('predict') }}">Predict</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('prediction_history') }}">History</a></li>
          {% endif %}
        </ul>

        <form class="d-flex nav-search ms-lg-3 my-2 my-lg-0" onsubmit="return false;">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input class="form-control" placeholder="Search…" readonly>
          </div>
        </form>

        <ul class="navbar-nav align-items-center ms-lg-3 gap-1 w-100 w-lg-auto">
          <!-- Notifications -->
          <li class="nav-item dropdown ms-lg-0 ms-auto">
            <a class="nav-link position-relative" href="#" data-bs-toggle="dropdown">
              <i class="bi bi-bell"></i>
              {% if notif_count and notif_count > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ notif_count }}</span>
              {% endif %}
            </a>
            <div class="dropdown-menu dropdown-menu-end p-0" style="width:320px;max-height:400px;overflow-y:auto;">
              <div class="list-group list-group-flush small">
                {% if notif_items %}
                  {% for n in notif_items %}
                    <div class="list-group-item d-flex align-items-start gap-2">
                      <i class="bi bi-activity text-primary"></i>
                      <div>{{ n.result or "New record" }}<div class="text-muted">{{ n.timestamp.strftime("%Y-%m-%d %H:%M") }}</div></div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="list-group-item text-center text-muted">No new notifications</div>
                {% endif %}
              </div>
            </div>
          </li>

          <!-- Theme toggle -->
          <li class="nav-item"><button id="themeToggle" class="btn btn-sm btn-ghost"><i class="bi bi-moon-stars" id="themeIcon"></i></button></li>

          <!-- Auth / User -->
          {% if current_user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown">
                <span class="avatar">{{ current_user.username[:2]|upper }}</span>
                <span class="d-none d-lg-inline">{{ current_user.username }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-person me-2"></i> Profile</a></li>
                <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item ms-lg-3 w-100 w-lg-auto">
              <div class="nav-actions">
                <a href="{{ url_for('recover') }}" class="link-light text-decoration-none">Forgot Password</a>
                <!-- Open REGISTER MODAL -->
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#signupModal">
                  <i class="bi bi-person-plus"></i> Create Account
                </button>
              </div>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main id="main-content" class="container-xxl pb-5">{% block content %}{% endblock %}</main>

  <!-- GLOBAL REGISTER MODAL -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header text-white" style="background:linear-gradient(90deg,#0d6efd,#6f42c1)">
          <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i> Create your account</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form class="needs-validation" method="POST" action="{{ url_for('register') }}" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

          <div class="modal-body p-4">
            <!-- Sample autofill buttons -->
            <div class="d-flex justify-content-end gap-2 mb-3" id="demoFillers">
              <button type="button" class="btn btn-outline-primary btn-sm" data-fill="employee">Sample: Employee</button>
              <button type="button" class="btn btn-outline-success btn-sm" data-fill="manager">Sample: Manager</button>
              <button type="button" class="btn btn-outline-info btn-sm" data-fill="hr">Sample: HR</button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Username <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input name="username" type="text" class="form-control" placeholder="e.g. jdoe" required minlength="3" maxlength="32">
                  <div class="invalid-feedback">Please enter a username (3–32 chars).</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                  <input name="email" type="email" class="form-control" placeholder="you@company.com" required>
                  <div class="invalid-feedback">Enter a valid email.</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lock"></i></span>
                  <input id="pw1" name="password" type="password" class="form-control" placeholder="At least 8 characters" required minlength="8">
                  <button class="btn btn-outline-secondary" type="button" id="togglePw1" aria-label="Show/Hide"><i class="bi bi-eye"></i></button>
                  <div class="invalid-feedback">Minimum 8 characters.</div>
                </div>
                <div class="progress mt-2" style="height:6px"><div id="pwStrength" class="progress-bar" role="progressbar" style="width:0%"></div></div>
                <div id="pwHint" class="form-text">Use upper/lowercase, a number, and a symbol.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                  <input id="pw2" name="confirm_password" type="password" class="form-control" placeholder="Re-type password" required minlength="8">
                  <button class="btn btn-outline-secondary" type="button" id="togglePw2" aria-label="Show/Hide"><i class="bi bi-eye"></i></button>
                  <div class="invalid-feedback">Passwords must match.</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Role <span class="text-danger">*</span></label>
                <select id="signupRoleSelect" name="role" class="form-select" required>
                  <option value="" selected disabled>Choose a role…</option>
                  <option value="EMPLOYEE">Employee</option>
                  <option value="MANAGER">Manager</option>
                  <option value="HR">HR</option>
                </select>
                <div class="invalid-feedback">Please select a role.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Agreement</label>
                <div class="form-check">
                  <input id="agree" class="form-check-input" type="checkbox" required>
                  <label class="form-check-label" for="agree">
                    I agree to the <a href="#" class="link-secondary">Terms</a> and <a href="#" class="link-secondary">Privacy Policy</a>.
                  </label>
                  <div class="invalid-feedback">You must accept the terms to continue.</div>
                </div>
              </div>
            </div>

            <hr class="my-4">
            <h6 class="mb-3"><i class="bi bi-card-checklist me-1"></i> Employee Details</h6>
            <div id="employeeFields" class="row g-3 d-none">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-person-vcard"></i></span><input name="name" type="text" class="form-control" placeholder="e.g. Jane Doe"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Employee ID</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-hash"></i></span><input name="employee_id" type="text" class="form-control" placeholder="e.g. EMP-00123"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Department</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-building"></i></span><input name="department" type="text" class="form-control" placeholder="e.g. Engineering"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Job Title</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-briefcase"></i></span><input name="title" type="text" class="form-control" placeholder="e.g. Software Engineer"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Manager</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-person-gear"></i></span><input name="manager_name" type="text" class="form-control" placeholder="e.g. Alex Smith"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-telephone"></i></span><input name="phone" type="text" class="form-control" placeholder="e.g. +1 555 555 5555"></div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Location</label>
                <div class="input-group"><span class="input-group-text"><i class="bi bi-geo-alt"></i></span><input name="location" type="text" class="form-control" placeholder="e.g. New York, NY"></div>
              </div>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between">
            <div class="text-muted small">
              <i class="bi bi-shield-check me-1"></i>
              New accounts are created as <strong>Pending</strong> until approved by an Admin.
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="signupSubmit" type="submit" class="btn btn-primary"><i class="bi bi-person-check"></i> Create Account</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-main">
      <div class="container-xxl row g-4">
        <div class="col-lg-4">
          <img src="{{ logo_url }}" alt="EPAS logo" class="footer-logo mb-2">
          <p class="small text-muted">Employee Attrition & Appraisal System helps forecast attrition and manage structured appraisals.</p>
          <p class="small mb-0">&copy; {{ current_year }} EAAS · All rights reserved.</p>
        </div>
        <div class="col-lg-4">
          <div class="footer-title">Resources</div>
          <div class="footer-links small"><a href="#">Guide</a><a href="#">Workflow</a><a href="#">Model</a><a href="#">FAQ</a></div>
          {% if session.get('role')|lower == 'hr' %}
            <div class="footer-title mt-2">HR Exports</div>
            <a class="btn btn-sm btn-outline-danger" href="{{ url_for('hr_export_pdf') }}">PDF</a>
            <a class="btn btn-sm btn-outline-success" href="{{ url_for('hr_export_excel') }}">Excel</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('hr_export_csv') }}">CSV</a>
          {% endif %}
        </div>
        <div class="col-lg-4">
          <div class="footer-title">Contact</div>
          <p class="small text-muted mb-1">Support: support@yourdomain.pg</p>
          <p class="small text-muted">Hours: Mon–Fri, 08:00–17:00</p>
          <div class="d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="#"><i class="bi bi-linkedin"></i></a>
            <a class="btn btn-sm btn-outline-secondary" href="#"><i class="bi bi-github"></i></a>
          </div>
        </div>
      </div>
    </div>
    <section class="footer-meta">
      <div class="container-xxl d-flex justify-content-between small">
        <div><a href="#">Privacy</a> · <a href="#">Terms</a> · <a href="#">Accessibility</a></div>
        <div>Made with ❤️ · EAAS</div>
      </div>
    </section>
  </footer>

  <a href="#" class="back-to-top btn btn-light"><i class="bi bi-arrow-up-short fs-3"></i></a>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Elevation on scroll + back-to-top
    const appbar=document.querySelector('.appbar'), backTop=document.querySelector('.back-to-top');
    window.addEventListener('scroll',()=>{const s=window.scrollY;appbar?.classList.toggle('elevated',s>6);backTop.style.display=s>200?'inline-flex':'none';});
    backTop?.addEventListener('click',e=>{e.preventDefault();window.scrollTo({top:0,behavior:'smooth'});});

    // Theme toggle
    (function(){
      const root=document.documentElement,key='eap-theme';
      const btn=document.getElementById('themeToggle'),icon=document.getElementById('themeIcon');
      function setTheme(t){root.setAttribute('data-bs-theme',t);localStorage.setItem(key,t);icon.className=(t==='dark')?'bi bi-sun':'bi bi-moon-stars';}
      setTheme(localStorage.getItem(key)||'light');
      btn?.addEventListener('click',()=>setTheme(root.getAttribute('data-bs-theme')==='dark'?'light':'dark'));
    })();

    // Signup modal JS (strength, show/hide, employee fields)
    (function(){
      const form = document.querySelector('#signupModal form.needs-validation');
      const pw1 = document.getElementById('pw1');
      const pw2 = document.getElementById('pw2');
      const bar = document.getElementById('pwStrength');
      const hint = document.getElementById('pwHint');

      function togglePw(input, btnId){
        const btn = document.getElementById(btnId);
        const eye = btn.querySelector('i');
        input.type = (input.type === 'password') ? 'text' : 'password';
        eye.className = (input.type === 'password') ? 'bi bi-eye' : 'bi bi-eye-slash';
      }
      document.getElementById('togglePw1')?.addEventListener('click', ()=>togglePw(pw1,'togglePw1'));
      document.getElementById('togglePw2')?.addEventListener('click', ()=>togglePw(pw2,'togglePw2'));

      function updateStrength(){
        const v = pw1?.value || '';
        const rules = [/[a-z]/,/[A-Z]/,/\d/,/[^A-Za-z0-9]/,/.{12,}/].map(r=>r.test(v));
        const score = rules.filter(Boolean).length;
        const pct = (score/5)*100;
        bar.style.width = pct + '%';
        bar.className = 'progress-bar';
        if (score <= 2) { bar.classList.add('bg-danger'); hint.textContent='Weak'; }
        else if (score === 3) { bar.classList.add('bg-warning'); hint.textContent='Fair'; }
        else if (score === 4) { bar.classList.add('bg-info'); hint.textContent='Good'; }
        else { bar.classList.add('bg-success'); hint.textContent='Strong'; }
      }
      pw1?.addEventListener('input', updateStrength);

      function pwMatch(){
        const ok = (pw1.value === pw2.value);
        pw2.setCustomValidity(ok ? '' : 'Passwords do not match'); return ok;
      }
      pw2?.addEventListener('input', pwMatch);

      const roleSelect = document.getElementById('signupRoleSelect');
      const empWrap = document.getElementById('employeeFields');
      const empNames = ['name','employee_id','department','title','manager_name','phone','location'];
      function updateEmployeeFields(){
        const isEmp = roleSelect?.value === 'EMPLOYEE';
        empWrap?.classList.toggle('d-none', !isEmp);
        empNames.forEach(n=>{
          const el = document.querySelector(`#signupModal [name="${n}"]`);
          if (!el) return;
          if (isEmp) el.setAttribute('required','');
          else el.removeAttribute('required');
        });
      }
      roleSelect?.addEventListener('change', updateEmployeeFields);

      form?.addEventListener('submit', (ev)=>{
        if (!form.checkValidity() || !pwMatch()) {
          ev.preventDefault(); ev.stopPropagation();
        }
        form.classList.add('was-validated');
      });
    })();

    /* === Demo autofill buttons (Employee, Manager, HR) — fixed === */
    (function(){
      const samples = {
        employee: {
          username: "evelyn.park",
          email: "evelyn.park@acme.com",
          password: "EPark#2025!",
          role: "EMPLOYEE",
          agree: true,
          details: {
            name: "Evelyn Park", employee_id: "E10234", department: "Sales",
            title: "Sales Associate", manager_name: "Jordan Reed",
            phone: "512-555-0163", location: "Austin, TX"
          }
        },
        manager: {
          username: "marco.lee",
          email: "marco.lee@acme.com",
          password: "MLee#2025!",
          role: "MANAGER",
          agree: true
        },
        hr: {
          username: "nina.patel",
          email: "nina.patel@acme.com",
          password: "NPatel#2025!",
          role: "HR",
          agree: true
        }
      };

      const $form = document.querySelector('#signupModal form.needs-validation');
      if (!$form) return;

      const $user  = $form.querySelector('[name="username"]');
      const $email = $form.querySelector('[name="email"]');
      const $pw1   = $form.querySelector('#pw1');
      const $pw2   = $form.querySelector('#pw2');
      const $role  = $form.querySelector('#signupRoleSelect');
      const $agree = $form.querySelector('#agree');

      function setVal(el, v){
        if(!el) return;
        el.value = v;
        el.dispatchEvent(new Event('input', { bubbles:true }));
      }
      function setChecked(el, v){ if(el) el.checked = !!v; }
      function setChange(el){ if(el) el.dispatchEvent(new Event('change', { bubbles:true })); }

      function fillDetails(d){
        if(!d) return;
        ['name','employee_id','department','title','manager_name','phone','location'].forEach(n=>{
          const el = $form.querySelector(`[name="${n}"]`);
          if (el) setVal(el, d[n] ?? '');
        });
      }

      function fill(sample){
        if(!sample) return;
        setVal($user, sample.username);
        setVal($email, sample.email);
        setVal($pw1, sample.password);
        setVal($pw2, sample.password);
        if ($role) { $role.value = sample.role; setChange($role); }
        setChecked($agree, sample.agree);
        fillDetails(sample.details);
      }

      document.querySelectorAll('#demoFillers [data-fill]').forEach(btn=>{
        btn.addEventListener('click', ()=> fill(samples[btn.dataset.fill]));
      });
    })();
  </script>

  <!-- Page-specific scripts (e.g., predict_form’s handlers) -->
  {% block scripts_extra %}{% endblock %}
<script>
  // Attach CSRF header to all fetch POST/PUT/PATCH/DELETE automatically
  (function(){
    const CSRF = document.querySelector('meta[name="csrf-token"]')?.content;
    if (!window.fetch || !CSRF) return;
    const origFetch = window.fetch;
    window.fetch = (input, init={})=>{
      const method = (init.method||'GET').toUpperCase();
      if (['POST','PUT','PATCH','DELETE'].includes(method)) {
        init.headers = Object.assign({}, init.headers, {'X-CSRFToken': CSRF});
      }
      return origFetch(input, init);
    };
  })();
</script>

</body>
</html>
