{% extends "base.html" %}

{% block title %}Employee · Dashboard{% endblock %}

{% block header %}
<div class="d-flex justify-content-between align-items-center">
  <h2 class="page-title"><i class="bi bi-person-circle me-2"></i> Employee Dashboard</h2>
  <div class="text-muted">
    {% if current_cycle %}<span class="badge text-bg-secondary me-2">Cycle: {{ current_cycle }}</span>{% endif %}
  </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

  <!-- ===== Actions ===== -->
  <div class="card mb-4">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
      <a href="{{ url_for('appraisal.employee_new_appraisal') }}" class="btn btn-primary">
        <i class="bi bi-pencil-square me-1"></i> Start / Continue Self-Appraisal
      </a>
      <a href="{{ url_for('appraisal.employee_list_appraisals') }}" class="btn btn-outline-secondary">
        <i class="bi bi-list-task me-1"></i> My Appraisals
      </a>
      {% if appraisal_deadline %}
        <span class="ms-auto small text-muted">
          <i class="bi bi-hourglass-split me-1"></i>
          Deadline:
          {{ (appraisal_deadline.strftime('%Y-%m-%d') if appraisal_deadline.__class__.__name__ in ['datetime','date'] else appraisal_deadline)|default('—') }}
        </span>
      {% endif %}
    </div>
  </div>

  <!-- ===== Top Stats ===== -->
  <div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header">Active Appraisal</div>
        <div class="card-body">
          {% if active_appraisal %}
            <div class="mb-2">
              <div class="small text-muted">Status</div>
              <div class="fw-semibold">
                {{ (active_appraisal.status if active_appraisal is defined and active_appraisal else 'Not started')|title }}
              </div>
            </div>
            <div class="small text-muted mb-1">Last updated</div>
            <div class="mb-3">
              {{ (active_appraisal.updated_at.strftime('%Y-%m-%d %H:%M') if active_appraisal.updated_at else '—') }}
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}">
              Continue <i class="bi bi-arrow-right-short"></i>
            </a>
          {% else %}
            <p class="text-muted mb-3">No active appraisal yet.</p>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}">
              Start Now
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card h-100">
        <div class="card-header">My Progress</div>
        <div class="card-body">
          {% set pct = (self_progress if self_progress is not none else 0) %}
          <div class="d-flex align-items-baseline gap-2 mb-2">
            <div class="display-6 fw-bold">{{ pct|int }}%</div>
            <div class="text-muted">completed</div>
          </div>
          <div class="progress" role="progressbar" aria-valuenow="{{ pct|int }}" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width: {{ pct|int }}%"></div>
          </div>
          <div class="small text-muted mt-2">Complete each section below to reach 100%.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">Completed Appraisals</div>
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="display-6 fw-bold">{{ appraisals_count or 0 }}</div>
            <div class="text-muted">submitted</div>
          </div>
          <a class="btn btn-outline-success" href="{{ url_for('appraisal.employee_list_appraisals') }}">
            View All
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Section Checklist ===== -->
  <div class="card mb-4">
    <div class="card-header">Appraisal Sections</div>
    <div class="card-body">
      {% set sections = section_progress or [] %}
      {% if sections %}
        <div class="list-group list-group-flush">
          {% for s in sections %}
            <div class="list-group-item d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center gap-2">
                <i class="bi {{ 'bi-check-circle-fill text-success' if s.get('done') else 'bi-circle text-muted' }}"></i>
                <span>{{ s.get('name','Section') }}</span>
              </div>
              <a class="btn btn-sm btn-outline-primary" href="{{ s.get('url', url_for('appraisal.employee_new_appraisal')) }}">Open</a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">Sections will appear once you start your self-appraisal.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== Readiness & Snapshot ===== -->
  <div class="row g-4 mb-4">
    <!-- Submission Readiness -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Submission Readiness</div>
        <div class="card-body">
          {% set chk = (checklist if checklist is defined else {}) %}
          <div class="row g-3">
            {% for label,key in [
              ('Identity & Period','identity'),
              ('Duties & Examples (1–10)','duties'),
              ('Workload (Sem 1 & 2)','workload'),
              ('Time Allocation totals 100%','time_allocation'),
              ('Publications / Evidence','publications'),
              ('Employee Comment','employee_comment'),
              ('E-Signature','signature')
            ] %}
              <div class="col-12 col-md-6">
                <div class="d-flex align-items-center gap-2">
                  {% set ok = chk.get(key) if chk else None %}
                  <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-circle text-muted' }}"></i>
                  <span>{{ label }}</span>
                </div>
              </div>
            {% endfor %}
          </div>
          <div class="mt-3 d-flex gap-2">
            <a class="btn btn-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}"><i class="bi bi-pencil-square me-1"></i>Open Self-Appraisal</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('appraisal.employee_list_appraisals') }}"><i class="bi bi-list-task me-1"></i>My Appraisals</a>
          </div>
          <p class="small text-muted mb-0 mt-2">Tip: all items should be ticked before you submit to your manager.</p>
        </div>
      </div>
    </div>

    <!-- Latest Appraisal Snapshot -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Latest Appraisal Snapshot</div>
        <div class="card-body">
          {% set latest = latest_appraisal if latest_appraisal is defined else (active_appraisal if active_appraisal else None) %}
          {% if latest %}
            <div class="row g-2">
              <div class="col-6">
                <div class="small text-muted">Period</div>
                <div class="fw-semibold">
                  {{ latest.period_start or '—' }} → {{ latest.period_end or '—' }}
                </div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Status</div>
                <span class="badge text-bg-secondary">{{ latest.status|default('—')|title }}</span>
              </div>
              <div class="col-6">
                <div class="small text-muted">Total Score</div>
                <div class="fs-5 fw-bold">{{ latest.total_score|default('—') }}</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Last Updated</div>
                <div>{{ (latest.updated_at.strftime('%Y-%m-%d %H:%M') if latest.updated_at else '—') }}</div>
              </div>
            </div>
            <a class="btn btn-sm btn-outline-primary mt-3" href="{{ url_for('appraisal.employee_new_appraisal') }}">View / Edit</a>
          {% else %}
            <p class="text-muted mb-0">No appraisal started yet. Click “Start / Continue Self-Appraisal”.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Workload & Evidence ===== -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Workload Snapshot</div>
        <div class="card-body">
          {% set wl = (active_appraisal.workload if active_appraisal is defined and active_appraisal and active_appraisal.workload is defined else None) %}
          {% if wl %}
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <div class="small text-muted">Teaching %</div>
                <div class="progress"><div class="progress-bar" style="width: {{ wl.teaching_percent|default(0) }}%"></div></div>
                <div class="mt-1">{{ wl.teaching_percent|default(0) }}%</div>
              </div>
              <div class="col-12 col-md-4">
                <div class="small text-muted">Research %</div>
                <div class="progress"><div class="progress-bar" style="width: {{ wl.research_percent|default(0) }}%"></div></div>
                <div class="mt-1">{{ wl.research_percent|default(0) }}%</div>
              </div>
              <div class="col-12 col-md-4">
                <div class="small text-muted">Other %</div>
                <div class="progress"><div class="progress-bar" style="width: {{ wl.other_percent|default(0) }}%"></div></div>
                <div class="mt-1">{{ wl.other_percent|default(0) }}%</div>
              </div>
            </div>
            <div class="small text-muted mt-2">Ensure the total equals 100% before submitting.</div>
          {% else %}
            <p class="text-muted mb-2">No workload captured yet.</p>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('appraisal.employee_new_appraisal') }}">Add Workload</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Publications & Evidence</div>
        <div class="card-body">
          {% if publications and publications|length > 0 %}
            <ul class="list-group list-group-flush">
              {% for p in publications[:5] %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <span class="me-2">{{ p.citation_text or p.title or 'Entry' }}</span>
                  <span class="small text-muted">{{ p.year or '' }}</span>
                </li>
              {% endfor %}
            </ul>
            {% if publications|length > 5 %}
              <div class="small text-muted mt-2">+ {{ publications|length - 5 }} more</div>
            {% endif %}
          {% else %}
            <p class="text-muted mb-2">No publications/evidence added.</p>
          {% endif %}
          <a class="btn btn-sm btn-outline-primary mt-2" href="{{ url_for('appraisal.employee_new_appraisal') }}">Update in Self-Appraisal</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Goals & Announcements ===== -->
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">My Goals</div>
        <div class="card-body">
          {% if goals %}
            <ul class="list-group list-group-flush">
              {% for g in goals %}
                <li class="list-group-item">
                  <div class="fw-semibold">{{ g.title or g.name or 'Goal' }}</div>
                  <div class="small text-muted">
                    {{ (g.description or '')[:160] }}{% if (g.description or '')|length > 160 %}…{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No goals captured yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card mb-4">
        <div class="card-header">Recent Feedback</div>
        <div class="card-body">
          {% if feedback %}
            <ul class="list-group list-group-flush">
              {% for f in feedback %}
                <li class="list-group-item">
                  <div class="small text-muted">{{ f.created_at.strftime('%Y-%m-%d') if f.created_at else '' }}</div>
                  <div>{{ f.text or f.comment or '—' }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No feedback yet.</p>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header">Announcements</div>
        <div class="card-body">
          {% if announcements %}
            <ul class="list-group list-group-flush">
              {% for a in announcements %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ a.title or 'Announcement' }}</span>
                  <span class="small text-muted">{{ a.created_at.strftime('%Y-%m-%d') if a.created_at else '' }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">No announcements.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border:0;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08)">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i> My Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Tabs: Overview / Edit -->
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pf-overview-tab" data-bs-toggle="tab" data-bs-target="#pf-overview" type="button" role="tab">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="pf-edit-tab" data-bs-toggle="tab" data-bs-target="#pf-edit" type="button" role="tab">Edit</button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- Overview -->
          <div class="tab-pane fade show active" id="pf-overview" role="tabpanel" aria-labelledby="pf-overview-tab">
            <div class="row g-3">
              <div class="col-12 col-lg-4">
                <div class="card h-100">
                  <div class="card-body d-flex align-items-center gap-3">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                         style="width:64px;height:64px;background:#eef2ff;font-weight:700;">
                      {{ (current_user.name or current_user.username or 'U')[:1] | upper }}
                    </div>
                    <div>
                      <div class="h5 mb-0">
                        {{ current_user.name
                           or current_user.full_name
                           or current_user.fullname
                           or current_user.display_name
                           or current_user.username
                           or 'User' }}
                      </div>
                      <div class="text-muted">{{ current_user.email or '—' }}</div>
                      {% if current_user.role %}<span class="badge bg-secondary mt-2">{{ role_str(current_user.role)|upper }}</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-8">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="row gy-2">

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.employee_id
                                          or current_user.emp_id
                                          or '—' }}" disabled>
                          <label>Employee ID</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.department
                                          or current_user.dept
                                          or current_user.department_name
                                          or '—' }}" disabled>
                          <label>Department</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.title
                                          or current_user.job_title
                                          or current_user.jobTitle
                                          or '—' }}" disabled>
                          <label>Job Title</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.manager_name
                                          or current_user.supervisor_name
                                          or '—' }}" disabled>
                          <label>Manager</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.phone
                                          or current_user.phone_number
                                          or current_user.mobile
                                          or '—' }}" disabled>
                          <label>Phone</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="form-floating">
                          <input class="form-control"
                                 value="{{ current_user.location
                                          or current_user.office
                                          or current_user.office_location
                                          or current_user.city
                                          or '—' }}" disabled>
                          <label>Location</label>
                        </div>
                      </div>

                    </div><!-- /row -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit -->
          <div class="tab-pane fade" id="pf-edit" role="tabpanel" aria-labelledby="pf-edit-tab">
            <form method="POST" action="{{ url_for('account.update_profile') }}" id="profileForm" class="needs-validation" novalidate>
              {# {{ form.csrf_token }} #}

              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="name" value="{{ current_user.name or '' }}" required>
                    <label>Full Name</label>
                    <div class="invalid-feedback">Name is required.</div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="email" class="form-control" name="email" value="{{ current_user.email or '' }}" {% if current_user.email %}readonly{% endif %}>
                    <label>Email</label>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="department" value="{{ current_user.department or '' }}">
                    <label>Department</label>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="title" value="{{ current_user.title or current_user.job_title or '' }}">
                    <label>Job Title</label>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="manager_name" value="{{ current_user.manager_name or '' }}">
                    <label>Manager</label>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="phone" value="{{ current_user.phone or '' }}">
                    <label>Phone</label>
                  </div>
                </div>

                <div class="col-12 col-md-6">
                  <div class="form-floating">
                    <input type="text" class="form-control" name="location" value="{{ current_user.location or '' }}">
                    <label>Location</label>
                  </div>
                </div>

                <!-- Optional: password change -->
                <div class="col-12">
                  <div class="accordion" id="pwAccordion">
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="pwHead">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pwCollapse">Change Password (optional)</button>
                      </h2>
                      <div id="pwCollapse" class="accordion-collapse collapse" data-bs-parent="#pwAccordion">
                        <div class="accordion-body">
                          <div class="row g-3">
                            <div class="col-12 col-md-6">
                              <div class="form-floating">
                                <input type="password" class="form-control" name="password">
                                <label>New Password</label>
                              </div>
                            </div>
                            <div class="col-12 col-md-6">
                              <div class="form-floating">
                                <input type="password" class="form-control" name="password_confirm">
                                <label>Confirm Password</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div> <!-- /tab-content -->
      </div>

    </div>
  </div>
</div>

<script>
  // Client-side validation (Bootstrap)
  (function () {
    const form = document.getElementById('profileForm');
    if (!form) return;
    form.addEventListener('submit', function (e) {
      if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
      form.classList.add('was-validated');
    }, false);
  })();

  // AJAX submit for in-place update
  (function () {
    const form = document.getElementById('profileForm');
    if (!form) return;

    form.addEventListener('submit', async function (e) {
      if (!form.checkValidity()) return; // fall back to normal POST if invalid
      e.preventDefault();

      const fd = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: 'POST',
          body: fd,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          showToast(data.message || 'Update failed.', 'danger');
          return;
        }

        // Update Overview fields in-place
        const getVal = (v) => (v && String(v).trim()) ? v : '—';

        // Left card (name + role)
        const nameEl  = document.querySelector('#pf-overview .card .h5');
        const roleTag = document.querySelector('#pf-overview .card .badge');
        if (nameEl && data.user.name) nameEl.textContent = data.user.name;
        if (roleTag && data.user.role) roleTag.textContent = data.user.role.toUpperCase();

        // Floating display inputs (disabled) matched by label
        const map = {
          'Employee ID': data.user.employee_id,
          'Department': data.user.department,
          'Job Title': data.user.title,
          'Manager': data.user.manager_name,
          'Phone': data.user.phone,
          'Location': data.user.location
        };
        document.querySelectorAll('#pf-overview .form-floating').forEach(ff => {
          const label = ff.querySelector('label')?.textContent?.trim();
          const input = ff.querySelector('input.form-control');
          if (label && input && (label in map)) input.value = getVal(map[label]);
        });

        // Update navbar dropdown display name if present
        const navbarName = document.querySelector('.navbar .dropdown .dropdown-item-text .fw-semibold');
        if (navbarName && data.user.name) navbarName.textContent = data.user.name;

        showToast('Profile updated.', 'success');

        // Switch to Overview tab
        const tabTrigger = document.querySelector('#pf-overview-tab');
        if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
      } catch (err) {
        showToast('Network error. Please try again.', 'danger');
      }
    });

    function showToast(message, type) {
      const container = document.querySelector('.toast-container') || (() => {
        const c = document.createElement('div');
        c.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(c);
        return c;
      })();

      const t = document.createElement('div');
      t.className = `toast align-items-center text-bg-${type} border-0`;
      t.role = 'alert';
      t.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      container.appendChild(t);
      new bootstrap.Toast(t, { delay: 3500 }).show();
    }
  })();

  // Optional: open the modal when arriving with ?open=profile
  (function(){
    const p = new URLSearchParams(location.search);
    if (p.get('open') === 'profile') {
      const m = document.getElementById('profileModal');
      if (m) new bootstrap.Modal(m).show();
    }
  })();
</script>
{% endblock %}
