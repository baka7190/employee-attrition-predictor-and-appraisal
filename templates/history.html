{# templates/history.html #}
{% extends "base.html" %}
{% block title %}Prediction History · EPAS{% endblock %}

{% block head_extra %}
<style>
  :root{ --radius:14px; }
  .page-header{ position: sticky; top: 0; z-index: 20; border-bottom: 1px solid var(--bs-border-color); background: var(--bs-body-bg); }
  .stat-card .icon-wrap{ width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background: var(--bs-secondary-bg); }
  .filter-toolbar{ border: 1px solid var(--bs-border-color); border-radius: var(--radius); padding: .75rem; background: var(--bs-body-bg); }
  .timeline{ border-radius: var(--radius); overflow: hidden; }
  .timeline .list-group-item{ background: var(--bs-body-bg); }
  .badge-soft{ background: color-mix(in oklab, var(--bs-primary) 16%, transparent); color: var(--bs-primary-text-emphasis); border: 1px solid color-mix(in oklab, var(--bs-primary) 30%, transparent); }
  .badge-soft-success{ background: color-mix(in oklab, var(--bs-success) 18%, transparent); color: var(--bs-success-text-emphasis); border: 1px solid color-mix(in oklab, var(--bs-success) 30%, transparent); }
  .badge-soft-danger{ background: color-mix(in oklab, var(--bs-danger) 18%, transparent); color: var(--bs-danger-text-emphasis); border: 1px solid color-mix(in oklab, var(--bs-danger) 30%, transparent); }
  .detail .table>:not(caption)>*>*{ padding:.5rem .6rem; }
  .empty{ border: 1px dashed var(--bs-border-color); border-radius: var(--radius); background: var(--bs-body-bg); }
</style>
{% endblock %}

{% block nav_items %}
  <a class="nav-link" href="{{ url_for('dashboard') }}"><i class="bi bi-house"></i> Overview</a>
  {% if session.get('role')|lower in ['manager','hr'] %}
    <a class="nav-link" href="{{ url_for('predict') }}"><i class="bi bi-magic"></i> Predict</a>
  {% endif %}
  <a class="nav-link active" href="{{ url_for('prediction_history') }}"><i class="bi bi-clock-history"></i> History</a>
{% endblock %}

{% block content %}
  <header class="page-header">
    <div class="d-flex flex-wrap align-items-center justify-content-between py-3 gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="d-inline-flex align-items-center justify-content-center rounded-3 bg-primary-subtle text-primary" style="width:40px;height:40px">
          <i class="bi bi-clock-history"></i>
        </div>
        <div>
          <h1 class="h4 mb-0 fw-bold">Prediction History</h1>
          <div class="text-body-secondary small">Review, search and export past predictions.</div>
        </div>
      </div>

      <div class="row g-2 text-nowrap">
        <div class="col-auto">
          <div class="stat-card card shadow-sm border-0">
            <div class="card-body py-2 px-3 d-flex align-items-center gap-2">
              <div class="icon-wrap text-primary"><i class="bi bi-collection"></i></div>
              <div>
                <div class="text-body-secondary small">Total</div>
                <div class="fw-bold">{{ (predictions|length) if predictions else 0 }}</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-auto">
          <div class="stat-card card shadow-sm border-0">
            <div class="card-body py-2 px-3 d-flex align-items-center gap-2">
              <div class="icon-wrap text-danger"><i class="bi bi-exclamation-octagon"></i></div>
              <div>
                <div class="text-body-secondary small">Yes</div>
                <div class="fw-bold">
                  {{ predictions|selectattr('result','equalto','Yes')|list|length if predictions else 0 }}
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-auto">
          <div class="stat-card card shadow-sm border-0">
            <div class="card-body py-2 px-3 d-flex align-items-center gap-2">
              <div class="icon-wrap text-success"><i class="bi bi-shield-check"></i></div>
              <div>
                <div class="text-body-secondary small">No</div>
                <div class="fw-bold">
                  {{ predictions|selectattr('result','equalto','No')|list|length if predictions else 0 }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== Toolbar ===== -->
  <div class="filter-toolbar d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="input-group input-group-sm" style="min-width:260px;max-width:420px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input id="q" class="form-control" placeholder="Search feature/value…" autocomplete="off">
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2">
      <div class="btn-group btn-group-sm" role="group" aria-label="Filter by result">
        <button class="btn btn-outline-secondary active" data-filter="all">All</button>
        <button class="btn btn-outline-danger" data-filter="yes"><i class="bi bi-activity me-1"></i>Yes</button>
        <button class="btn btn-outline-success" data-filter="no"><i class="bi bi-check2-circle me-1"></i>No</button>
      </div>

      {% if predictions %}
      {% set clear_ep = 'clear_predictions' if session.get('role','').upper() == 'ADMIN' else 'clear_my_predictions' %}
      <form method="POST"
            action="{{ url_for(clear_ep) }}"
            class="d-inline needs-confirm"
            data-confirm="Clear all prediction history? This cannot be undone."
            data-action="{{ url_for(clear_ep) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-outline-danger btn-sm" type="submit">
          <i class="bi bi-trash"></i> Clear All
        </button>
      </form>
      {% endif %}

      <a href="{{ url_for('predict') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> New Prediction</a>
    </div>
  </div>

  {% if predictions %}
  <div class="card shadow-sm border-0">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Results</span>
      <span class="small text-body-secondary">Showing <span id="shownCount">{{ predictions|length }}</span> of {{ predictions|length }}</span>
    </div>

    <div class="list-group list-group-flush timeline">
      {% for pred in predictions %}
      <div class="list-group-item py-3"
           id="run-{{ pred.id }}"
           data-result="{{ 'yes' if pred.result|lower == 'yes' else 'no' }}"
           data-search="{{ (pred.result ~ ' ' ~ pred.confidence ~ ' ' ~ pred.timestamp.strftime('%Y-%m-%d %H:%M:%S') ~ ' ' ~ (pred.input_data|default({})|tojson))|lower }}">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
          <div class="d-flex align-items-center gap-3">
            {% if pred.result|lower == 'yes' %}
              <span class="badge rounded-pill badge-soft-danger px-3 py-2">Yes</span>
            {% else %}
              <span class="badge rounded-pill badge-soft-success px-3 py-2">No</span>
            {% endif %}
            <div class="text-body-secondary small">Confidence:
              <strong class="text-body">{{ pred.confidence }}</strong>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <div class="small text-body-secondary"><i class="bi bi-clock me-1"></i>{{ pred.timestamp.strftime("%Y-%m-%d %H:%M:%S") }}</div>

            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#d{{ loop.index }}">
              <i class="bi bi-caret-down-square"></i> Details
            </button>

            <form method="POST"
                  action="{{ url_for('delete_prediction', prediction_id=pred.id) }}"
                  class="d-inline needs-confirm"
                  data-confirm="Delete this record? This cannot be undone."
                  data-action="{{ url_for('delete_prediction', prediction_id=pred.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">
                <i class="bi bi-trash3"></i> Delete
              </button>
            </form>
          </div>
        </div>

        <div id="d{{ loop.index }}" class="collapse mt-3">
          <div class="detail card card-body border-0 bg-body-tertiary">
            {% if pred.input_data %}
              <h6 class="fw-semibold mb-2">Employee Input Data</h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-secondary">
                    <tr><th class="w-25">Feature</th><th>Value</th></tr>
                  </thead>
                  <tbody>
                  {% for key, value in pred.input_data.items() %}
                    <tr>
                      <td class="text-body-secondary small">{{ key }}</td>
                      <td class="small">{{ value }}</td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="text-body-secondary fst-italic m-0">No input data available.</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div class="small text-body-secondary">End of list</div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-success btn-sm" href="{{ url_for('hr_export_excel') }}"><i class="bi bi-file-earmark-excel"></i> Export Excel</a>
        <a class="btn btn-outline-danger btn-sm" href="{{ url_for('hr_export_pdf') }}"><i class="bi bi-filetype-pdf"></i> Export PDF</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('hr_export_csv') }}"><i class="bi bi-filetype-csv"></i> Export CSV</a>
      </div>
    </div>
  </div>

  {% else %}
  <div class="empty text-center p-5">
    <div class="display-6 mb-2"><i class="bi bi-inbox"></i></div>
    <p class="mb-3">No predictions found yet.</p>
    <a href="{{ url_for('predict') }}" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle"></i> Make your first prediction</a>
  </div>
  {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
  const rows = Array.from(document.querySelectorAll('.list-group-item[data-result]'));
  const chips = Array.from(document.querySelectorAll('[data-filter]'));
  const shownCount = document.getElementById('shownCount');
  const q = document.getElementById('q');

  let activeFilter = 'all';
  let query = '';

  function apply(){
    const qq = (query || '').trim().toLowerCase();
    let shown = 0;
    rows.forEach(r=>{
      const res = r.dataset.result;
      const hay = r.dataset.search || '';
      const matchFilter = (activeFilter==='all') || (res===activeFilter);
      const matchQuery  = !qq || hay.includes(qq);
      const visible = matchFilter && matchQuery;
      r.classList.toggle('d-none', !visible);
      if(visible) shown++;
    });
    if (shownCount) shownCount.textContent = shown;
  }

  chips.forEach(ch=>{
    ch.addEventListener('click', ()=>{
      chips.forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      activeFilter = ch.dataset.filter;
      apply();
    });
  });

  q?.addEventListener('input', (e)=>{ query = e.target.value; apply(); });
  apply();
</script>
{% endblock %}
