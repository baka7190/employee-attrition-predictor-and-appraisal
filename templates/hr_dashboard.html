{% extends "base.html" %}
{% block title %}HR Control Center — People & Performance{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  /* === Fresh look: clean "control center" layout, minimal custom CSS === */
  :root{
    --cc-surface: var(--surface, #111827);
    --cc-line: var(--line, #e6eaf2);
    --cc-ink: var(--ink, #0f172a);
    --cc-muted: var(--muted, #64748b);
    --cc-brand: var(--brand, #3b82f6);
    --cc-brand2: var(--brand-2, #22d3ee);
    --cc-r: 14px;
    --cc-shadow: 0 14px 30px rgba(2,6,23,.15);
  }

  .cc-toolbar{
    border:1px solid var(--cc-line);
    background: var(--cc-surface);
    border-radius: var(--cc-r);
    box-shadow: var(--cc-shadow);
  }
  .cc-toolbar .nav-link{
    border-radius: 999px;
    padding: .35rem .9rem;
    font-weight: 600;
  }
  .cc-toolbar .nav-link.active{
    background: rgba(59,130,246,.22);
  }

  .cc-bento .card{
    border:1px solid var(--cc-line);
    background: var(--cc-surface);
    border-radius: var(--cc-r);
    box-shadow: var(--cc-shadow);
  }
  .cc-card-h{
    padding: .85rem 1rem;
    border-bottom:1px solid var(--cc-line);
    display:flex; align-items:center; justify-content:space-between;
  }
  .cc-card-t{ margin:0; font-size:1rem; font-weight:800; }
  .cc-card-b{ padding: 1rem; }

  .stat-tile{
    border: 1px dashed var(--cc-line);
    border-radius: 12px;
    padding: .9rem;
    display:flex; gap:.75rem; align-items:center;
    background: rgba(255,255,255,.04);
  }
  .stat-icon{
    width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
    background: rgba(59,130,246,.18);
  }
  .stat-label{ color: var(--cc-muted); font-size:.8rem; font-weight:600 }
  .stat-value{ font-size:1.45rem; font-weight:800 }

  .cc-kanban-col .list-group-item{
    border-color: var(--cc-line);
    border-left-width: 4px;
  }
  .cc-kanban-col .list-group-item .badge{ min-width: 74px }

  .cc-mini{
    border:1px solid var(--cc-line);
    background: var(--cc-surface);
    border-radius: 12px;
    padding: .6rem .75rem;
  }

  .chart-fit{ height: 280px !important; width: 100% !important; }

  /* sticky right rail on xl+ */
  @media (min-width: 1200px){
    .cc-right-rail{ position: sticky; top: 12px }
  }
</style>

<div class="container-xxl">
  <!-- ===== Top toolbar: Title | filters | quick actions ===== -->
  <div class="cc-toolbar p-3 mb-3">
    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
      <div class="d-flex align-items-center gap-3">
        <div>
          <div class="small text-muted">People & Performance</div>
          <h1 class="h3 fw-extrabold m-0">HR Control Center</h1>
        </div>
        <div class="vr d-none d-md-block"></div>
        <div class="cc-mini d-none d-md-flex align-items-center gap-2">
          <i class="bi bi-shield-check"></i>
          <span class="small">Cycle: <strong>FY{{ current_year }}</strong></span>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a href="{{ url_for('predict') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-graph-up"></i> Predict
        </a>
        <button class="btn btn-outline-success btn-sm" data-bs-toggle="offcanvas" data-bs-target="#csvCanvas">
          <i class="bi bi-file-earmark-spreadsheet"></i> Batch
        </button>
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mt-2">
      <ul class="nav nav-pills gap-2" id="ccPills">
        <li class="nav-item"><a class="nav-link active" href="#pane-attrition">Attrition</a></li>
        <li class="nav-item"><a class="nav-link" href="#pane-appraisals">Appraisals</a></li>
        <li class="nav-item"><a class="nav-link" href="#pane-ops">Ops & Reports</a></li>
        <li class="nav-item"><a class="nav-link" href="#pane-insights">Other Insights</a></li>
      </ul>

      <div class="d-flex gap-2">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control" placeholder="Search dashboard…" readonly>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Main content: bento + right rail ===== -->
  <div class="row g-3">
    <div class="col-xl-9">
      <div class="cc-bento">

        <!-- ===== Pane: Attrition ===== -->
        <div id="pane-attrition" class="card">
          <div class="cc-card-h">
            <h2 class="cc-card-t">Attrition Overview</h2>
            <span class="text-muted small">Last {{ (trend_dates|default([]))|length }} days</span>
          </div>
          <div class="cc-card-b">
            <!-- KPI row -->
            <div class="row g-3">
              <div class="col-6 col-lg-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-danger"><i class="bi bi-exclamation-octagon-fill"></i></div>
                  <div class="w-100">
                    <div class="stat-label">Attrition Risk</div>
                    <div class="stat-value">{{ (yes_rate|default(0)|float)|round(1) }}%</div>
                    {% set risk = yes_rate|default(0) %}
                    {% set bar = 'bg-success' if risk < 20 else ('bg-warning' if risk < 40 else 'bg-danger') %}
                    <div class="progress mt-2" style="height:6px"><div class="progress-bar {{ bar }}" style="width: {{ risk }}%"></div></div>
                  </div>
                </div>
              </div>
              <div class="col-6 col-lg-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-primary"><i class="bi bi-people-fill"></i></div>
                  <div>
                    <div class="stat-label">Total Employees</div>
                    <div class="stat-value">{{ total_employees|default(0) }}</div>
                  </div>
                </div>
              </div>
              <div class="col-6 col-lg-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-secondary"><i class="bi bi-clipboard-data"></i></div>
                  <div>
                    <div class="stat-label">Total Appraisals</div>
                    <div class="stat-value">{{ total_appraisals|default(0) }}</div>
                  </div>
                </div>
              </div>
              <div class="col-6 col-lg-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-success"><i class="bi bi-check2-circle"></i></div>
                  <div>
                    <div class="stat-label">Finalized</div>
                    <div class="stat-value">{{ hr_finalized_count|default(0) }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="row g-3 mt-1">
              <div class="col-lg-7">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Risk Trend</h3></div>
                  <div class="cc-card-b">
                    <canvas id="cc-chart-trend" class="chart-fit"></canvas>
                    <div class="small text-muted mt-2">Average predicted risk (%) per day.</div>
                  </div>
                </div>
              </div>
              <div class="col-lg-5">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Risk by Department</h3></div>
                  <div class="cc-card-b"><canvas id="cc-chart-dept" class="chart-fit"></canvas></div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">OverTime vs Risk</h3></div>
                  <div class="cc-card-b"><canvas id="cc-chart-ot" class="chart-fit"></canvas></div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Risk by Tenure</h3></div>
                  <div class="cc-card-b">
                    <canvas id="cc-chart-tenure" class="chart-fit"></canvas>
                    <div class="small text-muted mt-2">Yes-rate by years at company.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent predictions table -->
            <div class="card mt-3">
              <div class="cc-card-h"><h3 class="cc-card-t m-0">Recent Predictions</h3></div>
              <div class="cc-card-b">
                {% if recent_rows %}
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead><tr>
                        <th>Time</th><th>Result</th><th>Confidence</th><th>Department</th><th>Role</th><th>OverTime</th><th>Years</th>
                      </tr></thead>
                      <tbody>
                        {% for r in recent_rows %}
                        <tr>
                          <td class="text-nowrap">{{ r.ts }}</td>
                          <td><span class="badge rounded-pill text-bg-{{ 'danger' if r.result and r.result|lower=='yes' else 'success' }}">{{ r.result or 'N/A' }}</span></td>
                          <td>{{ r.proba }}</td>
                          <td>{{ r.dept }}</td>
                          <td>{{ r.role }}</td>
                          <td>{{ r.ot }}</td>
                          <td>{{ r.years }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="text-muted">No predictions available yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- ===== Pane: Appraisals ===== -->
        <div id="pane-appraisals" class="card mt-3">
          <div class="cc-card-h">
            <h2 class="cc-card-t">Appraisals Overview</h2>
            <div class="d-none d-md-flex gap-2">
              <span class="badge text-bg-secondary">Draft</span>
              <span class="badge text-bg-secondary">Mgr Submitted</span>
              <span class="badge text-bg-secondary">HR Reviewed</span>
              <span class="badge text-bg-success">Approved</span>
              <span class="badge text-bg-danger">Rejected</span>
            </div>
          </div>
          <div class="cc-card-b">
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-info"><i class="bi bi-send-check"></i></div>
                  <div><div class="stat-label">Awaiting HR</div><div class="stat-value">{{ hr_awaiting_count|default(0) }}</div></div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-secondary"><i class="bi bi-arrow-counterclockwise"></i></div>
                  <div><div class="stat-label">Returned</div><div class="stat-value">{{ hr_returned_count|default(0) }}</div></div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-success"><i class="bi bi-patch-check-fill"></i></div>
                  <div><div class="stat-label">Finalized</div><div class="stat-value">{{ hr_finalized_count|default(0) }}</div></div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="stat-tile h-100">
                  <div class="stat-icon text-warning"><i class="bi bi-clock-history"></i></div>
                  <div><div class="stat-label">Overdue</div><div class="stat-value">{{ hr_overdue_count|default(0) }}</div></div>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Status Distribution</h3></div>
                  <div class="cc-card-b">
                    <canvas id="cc-chart-status" class="chart-fit"></canvas>
                    <div class="small text-muted mt-2">Distribution of performance reviews.</div>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">HR Review Queue</h3></div>
                  <div class="cc-card-b">
                    {% set queue = hr_queue or [] %}
                    {% if queue %}
                      <div class="table-responsive">
                        <table class="table align-middle">
                          <thead><tr><th>#</th><th>Employee</th><th>Manager</th><th>Period</th><th>Status</th><th>Score</th><th class="text-end">Actions</th></tr></thead>
                          <tbody>
                            {% for q in queue[:10] %}
                            <tr>
                              <td class="text-muted">#{{ q.id }}</td>
                              <td>{{ q.employee_name or ('ID ' ~ q.employee_id) }}</td>
                              <td>{{ q.manager_name or ('ID ' ~ q.manager_id) }}</td>
                              <td>{{ q.period_start }} → {{ q.period_end }}</td>
                              <td><span class="badge text-bg-secondary">{{ q.status or 'MANAGER_SUBMITTED' }}</span></td>
                              <td>{{ q.total_score or '—' }}</td>
                              <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                  <a class="btn btn-outline-primary" href="{{ q.review_url or url_for('appraisal.hr_review_queue_ui') }}">Open</a>
                                  <a class="btn btn-outline-warning" href="{{ q.return_url or url_for('appraisal.hr_review_queue_ui') }}">Return</a>
                                  <a class="btn btn-success" href="{{ q.finalize_url or url_for('appraisal.hr_review_queue_ui') }}">Finalize</a>
                                </div>
                              </td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% else %}
                      <div class="text-muted">No items awaiting HR review.</div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="card">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Cycle Progress by Department</h3></div>
                  <div class="cc-card-b">
                    {% if dept_progress %}
                      <div class="table-responsive">
                        <table class="table align-middle">
                          <thead><tr><th>Department</th><th>Draft</th><th>Manager Submitted</th><th>HR Reviewed</th><th>Approved</th><th>Rejected</th></tr></thead>
                          <tbody>
                            {% for d in dept_progress %}
                            <tr>
                              <td>{{ d.name }}</td>
                              <td>{{ d.draft or 0 }}</td>
                              <td>{{ d.manager_submitted or 0 }}</td>
                              <td>{{ d.hr_reviewed or 0 }}</td>
                              <td>{{ d.approved or 0 }}</td>
                              <td>{{ d.rejected or 0 }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% else %}
                      <div class="text-muted">No progress data yet.</div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="card">
                  <div class="cc-card-h"><h3 class="cc-card-t m-0">Recently Finalized</h3></div>
                  <div class="cc-card-b">
                    {% if recent_appraisals %}
                      <div class="table-responsive">
                        <table class="table align-middle">
                          <thead><tr><th>#</th><th>Employee</th><th>Period</th><th>Score</th><th>Finalized</th></tr></thead>
                          <tbody>
                            {% for a in recent_appraisals[:12] %}
                            <tr>
                              <td class="text-muted">#{{ a.id }}</td>
                              <td>{{ a.employee_name or ('ID ' ~ a.employee_id) }}</td>
                              <td>{{ a.period_start }} → {{ a.period_end }}</td>
                              <td class="fw-semibold">{{ a.total_score or '—' }}</td>
                              <td>{{ a.finalized_at or '—' }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% else %}
                      <div class="text-muted">No finalized appraisals yet.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div> <!-- /row -->
          </div>
        </div>

        <!-- ===== Pane: Ops & Reports ===== -->
        <div id="pane-ops" class="card mt-3">
          <div class="cc-card-h">
            <h2 class="cc-card-t">Operations & Reports</h2>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-danger btn-sm" href="{{ url_for('appraisal.hr_export_pdf') }}">PDF</a>
              <a class="btn btn-outline-success btn-sm" href="{{ url_for('appraisal.hr_export_excel') }}">Excel</a>
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('appraisal.hr_export_csv') }}">CSV</a>
            </div>
          </div>
          <div class="cc-card-b">
            <div class="row g-3">
              <div class="col-lg-4">
                <div class="cc-kanban-col">
                  <div class="fw-bold mb-2">Prepare</div>
                  <div class="list-group">
                    <a class="list-group-item list-group-item-action border-start-primary" href="{{ url_for('appraisal.criteria_ui') }}">
                      <div class="d-flex justify-content-between"><span>Define Criteria</span><span class="badge text-bg-primary">Setup</span></div>
                    </a>
                    <a class="list-group-item list-group-item-action border-start-warning" href="{{ url_for('appraisal.assign_reviewers_ui') }}">
                      <div class="d-flex justify-content-between"><span>Assign Reviewers</span><span class="badge text-bg-warning">Owners</span></div>
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="cc-kanban-col">
                  <div class="fw-bold mb-2">Run</div>
                  <div class="list-group">
                    <a class="list-group-item list-group-item-action border-start-secondary" href="{{ url_for('appraisal.new_cycle') }}">
                      <div class="d-flex justify-content-between"><span>Launch Cycle</span><span class="badge text-bg-secondary">Start</span></div>
                    </a>
                    <a class="list-group-item list-group-item-action border-start-info" href="{{ url_for('appraisal.progress_ui') }}">
                      <div class="d-flex justify-content-between"><span>Monitor Progress</span><span class="badge text-bg-info">Live</span></div>
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="cc-kanban-col">
                  <div class="fw-bold mb-2">Close</div>
                  <div class="list-group">
                    <a class="list-group-item list-group-item-action border-start-success" href="{{ url_for('appraisal.hr_review_queue_ui') }}">
                      <div class="d-flex justify-content-between"><span>HR Review</span><span class="badge text-bg-success">Queue</span></div>
                    </a>
                    <a class="list-group-item list-group-item-action border-start-danger" href="{{ url_for('appraisal.calibrate_ui') }}">
                      <div class="d-flex justify-content-between"><span>Calibrate Ratings</span><span class="badge text-bg-danger">Scores</span></div>
                    </a>
                    <a class="list-group-item list-group-item-action border-start-dark" href="{{ url_for('appraisal.communicate_ui') }}">
                      <div class="d-flex justify-content-between"><span>Communicate Outcomes</span><span class="badge text-bg-dark">Notify</span></div>
                    </a>
                  </div>
                </div>
              </div>
            </div> <!-- /row -->
          </div>
        </div>

        <!-- ===== Pane: Other Insights ===== -->
        <div id="pane-insights" class="card mt-3">
          <div class="cc-card-h">
            <h2 class="cc-card-t">Other Insights</h2>
            <span class="small text-muted">Attendance, Recruitment, Engagement</span>
          </div>
          <div class="cc-card-b">
            <div class="accordion" id="cc-insights">
              <!-- Attendance -->
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cc-att">Attendance</button>
                </h2>
                <div id="cc-att" class="accordion-collapse collapse show" data-bs-parent="#cc-insights">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Attendance Trend</h3></div>
                          <div class="cc-card-b"><canvas id="chart-att-trend" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Absenteeism by Dept</h3></div>
                          <div class="cc-card-b"><canvas id="chart-abs-dept" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Attendance Table</h3></div>
                          <div class="cc-card-b"><div id="table-attendance"></div></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Recruitment -->
              <div class="accordion-item mt-2">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cc-rec">Recruitment</button>
                </h2>
                <div id="cc-rec" class="accordion-collapse collapse" data-bs-parent="#cc-insights">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Recruitment Funnel</h3></div>
                          <div class="cc-card-b"><canvas id="chart-recruit-funnel" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Time to Hire</h3></div>
                          <div class="cc-card-b"><canvas id="chart-time-to-hire" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Open Requisitions</h3></div>
                          <div class="cc-card-b"><div id="table-requisitions"></div></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Engagement -->
              <div class="accordion-item mt-2">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cc-eng">Engagement</button>
                </h2>
                <div id="cc-eng" class="accordion-collapse collapse" data-bs-parent="#cc-insights">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Engagement Index</h3></div>
                          <div class="cc-card-b"><canvas id="chart-eng-index" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">eNPS</h3></div>
                          <div class="cc-card-b"><canvas id="chart-enps" class="chart-fit"></canvas></div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="card">
                          <div class="cc-card-h"><h3 class="cc-card-t m-0">Survey Comments</h3></div>
                          <div class="cc-card-b"><div id="table-engagement-comments"></div></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- /accordion -->
            <div class="text-center text-muted small mt-3">Last updated {{ current_year }}</div>
          </div>
        </div>

      </div><!-- /bento -->
    </div>

    <!-- ===== Right rail: compact control blocks ===== -->
    <div class="col-xl-3">
      <div class="cc-right-rail d-flex flex-column gap-3">
        <div class="card">
          <div class="cc-card-h"><h3 class="cc-card-t m-0">Quick Actions</h3></div>
          <div class="cc-card-b d-grid gap-2">
            <a class="btn btn-outline-primary btn-sm" href="{{ url_for('appraisal.criteria_ui') }}"><i class="bi bi-sliders"></i> Define Criteria</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('appraisal.new_cycle') }}"><i class="bi bi-rocket-takeoff"></i> Launch Cycle</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('appraisal.assign_reviewers_ui') }}"><i class="bi bi-people"></i> Assign Reviewers</a>
            <a class="btn btn-outline-info btn-sm" href="{{ url_for('appraisal.progress_ui') }}"><i class="bi bi-activity"></i> Monitor Progress</a>
            <a class="btn btn-outline-success btn-sm" href="{{ url_for('appraisal.hr_review_queue_ui') }}"><i class="bi bi-inboxes"></i> HR Review</a>
          </div>
        </div>

        <div class="card">
          <div class="cc-card-h"><h3 class="cc-card-t m-0">Exports</h3></div>
          <div class="cc-card-b d-grid gap-2">
            <a class="btn btn-outline-danger btn-sm" href="{{ url_for('appraisal.hr_export_pdf') }}"><i class="bi bi-filetype-pdf"></i> PDF</a>
            <a class="btn btn-outline-success btn-sm" href="{{ url_for('appraisal.hr_export_excel') }}"><i class="bi bi-file-earmark-excel"></i> Excel</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('appraisal.hr_export_csv') }}"><i class="bi bi-filetype-csv"></i> CSV</a>
          </div>
        </div>

        <div class="card">
          <div class="cc-card-h"><h3 class="cc-card-t m-0">Signals</h3></div>
          <div class="cc-card-b">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="text-muted">Attrition Risk</span>
              <span class="badge text-bg-{{ 'success' if risk < 20 else ('warning' if risk < 40 else 'danger') }}">{{ (yes_rate|default(0)|float)|round(1) }}%</span>
            </div>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="text-muted">Finalized Appraisals</span>
              <span class="badge text-bg-success">{{ hr_finalized_count|default(0) }}</span>
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <span class="text-muted">Awaiting HR</span>
              <span class="badge text-bg-info">{{ hr_awaiting_count|default(0) }}</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div> <!-- /row -->
</div>

<!-- ===== Offcanvas: Batch Prediction (kept) ===== -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="csvCanvas" style="width:460px">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title"><i class="bi bi-file-earmark-spreadsheet"></i> Batch Prediction</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form method="POST" action="{{ url_for('predict') }}" enctype="multipart/form-data" class="card p-3">
      <div class="mb-3">
        <label class="form-label">Upload CSV/Excel</label>
        <input type="file" class="form-control" name="file" required>
      </div>
      <button class="btn btn-success w-100"><i class="bi bi-upload"></i> Predict from File</button>
    </form>
    <p class="text-muted mt-3">Ensure your columns match the fields used by the model.</p>
  </div>
</div>

<script>
  // ===== Bind backend data =====
  const trendDates   = {{ (trend_dates|default([]))|tojson }};
  const trendAvg     = {{ (trend_avg|default([]))|tojson }};
  const statusLabels = {{ (status_labels|default([]))|tojson }};
  const statusCounts = {{ (status_counts|default([]))|tojson }};
  const deptLabels   = {{ (dept_labels|default([]))|tojson }};
  const deptRates    = {{ (dept_rates|default([]))|tojson }};
  const otLabels     = {{ (ot_labels|default([]))|tojson }};
  const otRates      = {{ (ot_rates|default([]))|tojson }};
  const tenureLabels = {{ (tenure_labels|default([]))|tojson }};
  const tenureRates  = {{ (tenure_rates|default([]))|tojson }};

  function draw(id, cfg){
    const el = document.getElementById(id);
    if(!el) return;
    if(Chart.getChart){ const prev = Chart.getChart(id); if(prev) prev.destroy(); }
    return new Chart(el, cfg);
  }

  // Trim for readability
  const MAX = 60, start = Math.max(0, (trendDates||[]).length - MAX);
  const tL = (trendDates||[]).slice(start), tV = (trendAvg||[]).slice(start);

  // Charts
  draw('cc-chart-trend', {
    type:'line',
    data:{ labels:tL, datasets:[{ label:'Avg Risk (%)', data:tV, tension:.35 }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v+'%' } } }
    }
  });

  draw('cc-chart-dept', {
    type:'bar',
    data:{ labels:deptLabels, datasets:[{ label:'Yes Rate (%)', data:deptRates, borderRadius:8, maxBarThickness:64 }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v+'%' } } }
    }
  });

  draw('cc-chart-ot', {
    type:'bar',
    data:{ labels:otLabels, datasets:[{ label:'Yes Rate (%)', data:otRates, borderRadius:8, maxBarThickness:64 }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v+'%' } } }
    }
  });

  draw('cc-chart-tenure', {
    type:'polarArea',
    data:{ labels:tenureLabels, datasets:[{ data:tenureRates }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ position:'bottom' } },
      scales:{ r:{ ticks:{ callback:v=>v+'%' } } }
    }
  });

  draw('cc-chart-status', {
    type:'doughnut',
    data:{ labels:statusLabels, datasets:[{ data:statusCounts, cutout:'60%', radius:'80%' }]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false,
      plugins:{ legend:{ position:'bottom' } }
    }
  });

  // Pills active while scrolling
  const links = [...document.querySelectorAll('#ccPills .nav-link')];
  const targets = ['pane-attrition','pane-appraisals','pane-ops','pane-insights'].map(id=>document.getElementById(id)).filter(Boolean);
  const spy = new IntersectionObserver(entries=>{
    const v = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
    if(!v) return;
    links.forEach(l=>l.classList.toggle('active', l.getAttribute('href')==='#'+v.target.id));
  }, { threshold:.5 });
  targets.forEach(t=>spy.observe(t));
</script>
{% endblock %}
